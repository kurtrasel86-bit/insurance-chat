# –ê–Ω–∞–ª–∏–∑ —Ñ–∞–π–ª–æ–≤ –ø—Ä–æ–µ–∫—Ç–∞ –∏ —á–∞—Ç–∞
_Exported on 10/1/2025 at 18:35:31 GMT+7 from Cursor (1.6.35)_

---

**User**

–ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Ñ–∞–π–ª—ã –ø—Ä–æ–µ–∫—Ç–∞ –∏ —Å—Ç–∞—Ä—ã–π —á–∞—Ç (cursor_.md) –∏ –¥–∞–≤–∞–π –ø—Ä–æ–¥–æ–ª–∂–∏–º —Ä–∞–±–æ—Ç—É

---

**Cursor**

–Ø –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É—é —Ñ–∞–π–ª—ã –ø—Ä–æ–µ–∫—Ç–∞ –∏ —Å—Ç–∞—Ä—ã–π —á–∞—Ç, —á—Ç–æ–±—ã –ø–æ–Ω—è—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Ä–∞–±–æ—Ç—É.

–û—Ç–ª–∏—á–Ω–æ! –Ø –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–ª –ø—Ä–æ–µ–∫—Ç. –í–∏–∂—É, —á—Ç–æ –≤—ã —Ä–∞–±–æ—Ç–∞–µ—Ç–µ –Ω–∞–¥ **—Å–∏—Å—Ç–µ–º–æ–π —Å—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏—è —Å —á–∞—Ç-–±–æ—Ç–æ–º** –Ω–∞ NestJS + Telegram. –ü–æ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–µ, —á—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ:

‚úÖ NestJS —Å–µ—Ä–≤–µ—Ä —Å –º–æ–¥—É–ª—å–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π
‚úÖ JWT –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –¥–ª—è –∞–≥–µ–Ω—Ç–æ–≤
‚úÖ Telegram webhook –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
‚úÖ AI –∞–≤—Ç–æ–æ—Ç–≤–µ—Ç—ã —á–µ—Ä–µ–∑ OpenAI
‚úÖ –°—Ö–µ–º–∞ –ë–î —Å Prisma (SQLite)

–î–∞–≤–∞–π—Ç–µ –ø–æ—Å–º–æ—Ç—Ä—é —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–ª—é—á–µ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤:

–ü–æ–Ω—è–ª —Å–∏—Ç—É–∞—Ü–∏—é! –£ –≤–∞—Å –µ—Å—Ç—å:

‚úÖ **–†–∞–±–æ—Ç–∞—é—â–∏–π Telegram –±–æ—Ç** —Å AI –∞–≤—Ç–æ–æ—Ç–≤–µ—Ç–∞–º–∏  
‚úÖ **–°—Ö–µ–º–∞ –ë–î** –≤ Prisma (–≥–æ—Ç–æ–≤–∞, –Ω–æ –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∞)  
‚úÖ **In-memory —Ö—Ä–∞–Ω–∏–ª–∏—â–µ** –≤ ChatService (–Ω—É–∂–Ω–æ –º–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ –ë–î)

**–°–ª–µ–¥—É—é—â–∏–µ –ª–æ–≥–∏—á–Ω—ã–µ —à–∞–≥–∏:**

1. **–ü–æ–¥–∫–ª—é—á–∏—Ç—å Prisma** –∏ –º–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ —Ä–µ–∞–ª—å–Ω—É—é –ë–î
2. **–°–æ—Ö—Ä–∞–Ω—è—Ç—å –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–æ–≤** –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
3. **–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å Knowledge Base** –¥–ª—è —É–º–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤ (RAG)
4. **–î–æ–±–∞–≤–∏—Ç—å –≤–µ–±-–≤–∏–¥–∂–µ—Ç** –¥–ª—è —Å–∞–π—Ç–∞
5. **–°–æ–∑–¥–∞—Ç—å –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å** –¥–ª—è –∞–≥–µ–Ω—Ç–æ–≤

**–ß—Ç–æ –ø—Ä–µ–¥–ª–∞–≥–∞—é —Å–¥–µ–ª–∞—Ç—å —Å–µ–π—á–∞—Å:**

–î–∞–≤–∞–π—Ç–µ —Å–Ω–∞—á–∞–ª–∞ **–ø–æ–¥–∫–ª—é—á–∏–º Prisma –∏ –º–∏–≥—Ä–∏—Ä—É–µ–º ChatService –Ω–∞ —Ä–µ–∞–ª—å–Ω—É—é –ë–î**, —á—Ç–æ–±—ã –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è–ª–∏—Å—å –º–µ–∂–¥—É –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–º–∏. –≠—Ç–æ —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–π —Ä–∞–±–æ—Ç—ã.

–ü—Ä–æ–≤–µ—Ä—é, —á—Ç–æ —É –Ω–∞—Å –µ—Å—Ç—å:

–í–∏–∂—É –∫–∞—Ä—Ç–∏–Ω—É! –£ –≤–∞—Å:
- ‚úÖ Prisma —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ (–≤ package.json)
- ‚úÖ –°—Ö–µ–º–∞ –ë–î –≥–æ—Ç–æ–≤–∞ (schema.prisma)
- ‚ùå –ù–µ—Ç `.env` —Ñ–∞–π–ª–∞
- ‚ùå –ë–î –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞
- ‚ùå Prisma Client –Ω–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω

–î–∞–≤–∞–π—Ç–µ –ø–æ–¥–∫–ª—é—á–∏–º Prisma –∏ –º–∏–≥—Ä–∏—Ä—É–µ–º –Ω–∞ —Ä–µ–∞–ª—å–Ω—É—é –ë–î. –°–æ–∑–¥–∞–º –ø–ª–∞–Ω:

–§–∞–π–ª `.env` –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏. **–í–∞–º –Ω—É–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –µ–≥–æ –≤—Ä—É—á–Ω—É—é:**

**–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª** `insurance-chat/backend/.env` **—Å–æ —Å–ª–µ–¥—É—é—â–∏–º —Å–æ–¥–µ—Ä–∂–∏–º—ã–º:**

```env
DATABASE_URL="file:./dev.db"

TELEGRAM_BOT_TOKEN="8279197548:AAGXNdEXKQUVBoK_qY2D8dAZWjdzSl1qhmQ"

# –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ - –¥–ª—è OpenAI
# OPENAI_API_KEY="your-openai-api-key"
# OPENAI_MODEL="gpt-4o-mini"

JWT_SECRET="your-super-secret-jwt-key-change-this-in-production"
```

–ê –ø–æ–∫–∞ —è –∏—Å–ø—Ä–∞–≤–ª—é –æ—à–∏–±–∫—É –≤ —Å—Ö–µ–º–µ Prisma –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–ª—é –≤—Å–µ –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –ë–î:

```plaintext
DATABASE_URL="file:./dev.db"

TELEGRAM_BOT_TOKEN="8279197548:AAGXNdEXKQUVBoK_qY2D8dAZWjdzSl1qhmQ"

# –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ - –¥–ª—è OpenAI
# OPENAI_API_KEY="your-openai-api-key"
# OPENAI_MODEL="gpt-4o-mini"

JWT_SECRET="your-super-secret-jwt-key-change-this-in-production"
```

```plaintext
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id            String   @id @default(uuid())
  channel       String
  channelUserId String
  consent       Boolean  @default(false)
  preferVoice   Boolean  @default(false)
  email         String?  @unique
  sessions      ChatSession[]
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model Agent {
  id        String   @id @default(uuid())
  name      String
  login     String   @unique
  password  String
  status    String   @default("offline")
  companies String
  sessions  ChatSession[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ChatSession {
  id          String   @id @default(uuid())
  user        User     @relation(fields: [userId], references: [id])
  userId      String
  agent       Agent?   @relation(fields: [agentId], references: [id])
  agentId     String?
  state       String   @default("qa")
  preferVoice Boolean  @default(false)
  email       String?
  messages    Message[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Message {
  id        String   @id @default(uuid())
  session   ChatSession @relation(fields: [sessionId], references: [id])
  sessionId String
  sender    String
  text      String?
  voiceUrl  String?
  fileUrl   String?
  createdAt DateTime @default(now())
}

model Policy {
  id            String   @id @default(uuid())
  sessionId     String
  productType   String
  companyCode   String
  status        String
  pdfUrl        String?
  expireAt      DateTime?
  isAgentClient Boolean @default(false)
  createdAt     DateTime @default(now())
}

model Reminder {
  id         String   @id @default(uuid())
  policyId   String
  remindAt   DateTime
  recipients String
  status     String   @default("pending")
  createdAt  DateTime @default(now())
}

model KBDoc {
  id          String   @id @default(uuid())
  companyCode String
  productCode String
  title       String
  fileUrl     String?
  sourceUrl   String?
  version     String?
  chunks      KBChunk[]
  createdAt   DateTime @default(now())
}

model KBChunk {
  id       String  @id @default(uuid())
  doc      KBDoc   @relation(fields: [docId], references: [id])
  docId    String
  chunkIdx Int
  text     String
}

model Incident {
  id        String   @id @default(uuid())
  sessionId String?
  type      String
  details   String
  createdAt DateTime @default(now())
}
```

–¢–µ–ø–µ—Ä—å —Å–æ–∑–¥–∞–º Prisma –º–æ–¥—É–ª—å –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î:

```typescript
import { Injectable, OnModuleInit, OnModuleDestroy } from '@nestjs/common';
import { PrismaClient } from '@prisma/client';

@Injectable()
export class PrismaService extends PrismaClient implements OnModuleInit, OnModuleDestroy {
  async onModuleInit() {
    await this.$connect();
  }

  async onModuleDestroy() {
    await this.$disconnect();
  }
}

```

```typescript
import { Global, Module } from '@nestjs/common';
import { PrismaService } from './prisma.service';

@Global()
@Module({
  providers: [PrismaService],
  exports: [PrismaService],
})
export class PrismaModule {}

```

```typescript
import { Module } from '@nestjs/common';
import { AppController } from './app.controller';
import { AppService } from './app.service';
import { ChatModule } from './modules/chat/chat.module';
import { AuthModule } from './modules/auth/auth.module';
import { ChannelsModule } from './modules/channels/channels.module';
import { PrismaModule } from './modules/prisma/prisma.module';

@Module({
  imports: [PrismaModule, ChatModule, AuthModule, ChannelsModule],
  controllers: [AppController],
  providers: [AppService],
})
export class AppModule {}

```

```typescript
import { Injectable, NotFoundException } from '@nestjs/common';
import { PrismaService } from '../prisma/prisma.service';
import { CreateSessionDto, Message, PostMessageDto, Session } from './chat.dtos';

@Injectable()
export class ChatService {
  constructor(private readonly prisma: PrismaService) {}

  async createSession(dto: CreateSessionDto): Promise<Session> {
    // First, find or create user
    let user = await this.prisma.user.findFirst({
      where: {
        channel: dto.channel,
        channelUserId: dto.channelUserId,
      },
    });

    if (!user) {
      user = await this.prisma.user.create({
        data: {
          channel: dto.channel,
          channelUserId: dto.channelUserId,
          preferVoice: dto.preferVoice ?? false,
          email: dto.email,
        },
      });
    }

    // Create session
    const session = await this.prisma.chatSession.create({
      data: {
        userId: user.id,
        preferVoice: dto.preferVoice ?? false,
        email: dto.email,
      },
    });

    return {
      id: session.id,
      channel: dto.channel,
      channelUserId: dto.channelUserId,
      preferVoice: session.preferVoice,
      email: session.email ?? null,
      createdAt: session.createdAt.toISOString(),
    };
  }

  async getOrCreateSessionForChannel(channel: string, channelUserId: string): Promise<Session> {
    // Find user
    let user = await this.prisma.user.findFirst({
      where: {
        channel,
        channelUserId,
      },
      include: {
        sessions: {
          orderBy: {
            createdAt: 'desc',
          },
          take: 1,
        },
      },
    });

    if (!user) {
      // Create user and session
      user = await this.prisma.user.create({
        data: {
          channel,
          channelUserId,
          sessions: {
            create: {},
          },
        },
        include: {
          sessions: true,
        },
      });
    }

    // Get or create active session
    let session = user.sessions[0];
    if (!session) {
      session = await this.prisma.chatSession.create({
        data: {
          userId: user.id,
        },
      });
    }

    return {
      id: session.id,
      channel: user.channel,
      channelUserId: user.channelUserId,
      preferVoice: session.preferVoice,
      email: session.email ?? null,
      createdAt: session.createdAt.toISOString(),
    };
  }

  async postMessage(dto: PostMessageDto): Promise<Message> {
    const session = await this.prisma.chatSession.findUnique({
      where: { id: dto.sessionId },
    });

    if (!session) {
      throw new NotFoundException('Session not found');
    }

    const message = await this.prisma.message.create({
      data: {
        sessionId: dto.sessionId,
        sender: dto.sender,
        text: dto.text,
        voiceUrl: dto.voiceUrl,
        fileUrl: dto.fileUrl,
      },
    });

    return {
      id: message.id,
      sessionId: message.sessionId,
      sender: message.sender,
      text: message.text ?? null,
      voiceUrl: message.voiceUrl ?? null,
      fileUrl: message.fileUrl ?? null,
      createdAt: message.createdAt.toISOString(),
    };
  }

  async getMessages(sessionId: string) {
    const session = await this.prisma.chatSession.findUnique({
      where: { id: sessionId },
    });

    if (!session) {
      throw new NotFoundException('Session not found');
    }

    const messages = await this.prisma.message.findMany({
      where: { sessionId },
      orderBy: { createdAt: 'asc' },
    });

    return {
      items: messages.map((m) => ({
        id: m.id,
        sessionId: m.sessionId,
        sender: m.sender,
        text: m.text ?? null,
        voiceUrl: m.voiceUrl ?? null,
        fileUrl: m.fileUrl ?? null,
        createdAt: m.createdAt.toISOString(),
      })),
    };
  }
}



```

```typescript
import { Body, Controller, Post } from '@nestjs/common';
import { ChatService } from '../chat/chat.service';
import { AiService } from '../ai/ai.service';

type TelegramMessage = {
  message?: { message_id: number; chat: { id: number }; from?: { id: number; username?: string }; text?: string };
  edited_message?: { message_id: number; chat: { id: number }; from?: { id: number; username?: string }; text?: string };
};

@Controller('channels/telegram')
export class TelegramController {
  constructor(private readonly chat: ChatService, private readonly ai: AiService) {}

  @Post('webhook')
  async webhook(@Body() update: TelegramMessage) {
    const msg = update.message || update.edited_message;
    if (!msg || !msg.text) return { ok: true };
    const channelUserId = String(msg.from?.id ?? msg.chat.id);
    const session = await this.chat.getOrCreateSessionForChannel('telegram', channelUserId);
    await this.chat.postMessage({ sessionId: session.id, sender: 'user', text: msg.text });
    const aiReply = await this.ai.generateReply(msg.text);
    await this.chat.postMessage({ sessionId: session.id, sender: 'ai', text: aiReply });

    // Send reply back to Telegram chat if bot token is configured
    const botToken = process.env.TELEGRAM_BOT_TOKEN;
    if (botToken) {
      await fetch(`https://api.telegram.org/bot${botToken}/sendMessage`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ chat_id: msg.chat.id, text: aiReply }),
      }).catch(() => void 0);
    }

    return { ok: true };
  }
}



```

–û—Ç–ª–∏—á–Ω–æ! –ö–æ–¥ –º–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω –Ω–∞ Prisma. –¢–µ–ø–µ—Ä—å —Å–æ–∑–¥–∞–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Å–∫—Ä–∏–ø—Ç—ã:

```json
{
  "name": "backend",
  "version": "0.0.1",
  "description": "",
  "author": "",
  "private": true,
  "license": "UNLICENSED",
  "scripts": {
    "build": "nest build",
    "format": "prettier --write \"src/**/*.ts\" \"test/**/*.ts\"",
    "start": "nest start",
    "start:dev": "nest start --watch",
    "start:debug": "nest start --debug --watch",
    "start:prod": "node dist/main",
    "lint": "eslint \"{src,apps,libs,test}/**/*.ts\" --fix",
    "test": "jest",
    "test:watch": "jest --watch",
    "test:cov": "jest --coverage",
    "test:debug": "node --inspect-brk -r tsconfig-paths/register -r ts-node/register node_modules/.bin/jest --runInBand",
    "test:e2e": "jest --config ./test/jest-e2e.json",
    "prisma:generate": "prisma generate",
    "prisma:migrate": "prisma migrate dev",
    "prisma:studio": "prisma studio"
  },
  "dependencies": {
    "@nestjs/common": "^11.0.1",
    "@nestjs/config": "^4.0.2",
    "@nestjs/core": "^11.0.1",
    "@nestjs/jwt": "^11.0.0",
    "@nestjs/passport": "^11.0.5",
    "@nestjs/platform-express": "^11.0.1",
    "@prisma/client": "^6.16.2",
    "passport": "^0.7.0",
    "passport-jwt": "^4.0.1",
    "prisma": "^6.16.2",
    "reflect-metadata": "^0.2.2",
    "rxjs": "^7.8.1"
  },
  "devDependencies": {
    "@eslint/eslintrc": "^3.2.0",
    "@eslint/js": "^9.18.0",
    "@nestjs/cli": "^11.0.0",
    "@nestjs/schematics": "^11.0.0",
    "@nestjs/testing": "^11.0.1",
    "@types/express": "^5.0.0",
    "@types/jest": "^30.0.0",
    "@types/node": "^22.10.7",
    "@types/passport-jwt": "^4.0.1",
    "@types/supertest": "^6.0.2",
    "eslint": "^9.18.0",
    "eslint-config-prettier": "^10.0.1",
    "eslint-plugin-prettier": "^5.2.2",
    "globals": "^16.0.0",
    "jest": "^30.0.0",
    "prettier": "^3.4.2",
    "source-map-support": "^0.5.21",
    "supertest": "^7.0.0",
    "ts-jest": "^29.2.5",
    "ts-loader": "^9.5.2",
    "ts-node": "^10.9.2",
    "tsconfig-paths": "^4.2.0",
    "typescript": "^5.7.3",
    "typescript-eslint": "^8.20.0"
  },
  "jest": {
    "moduleFileExtensions": [
      "js",
      "json",
      "ts"
    ],
    "rootDir": "src",
    "testRegex": ".*\\.spec\\.ts$",
    "transform": {
      "^.+\\.(t|j)s$": "ts-jest"
    },
    "collectCoverageFrom": [
      "**/*.(t|j)s"
    ],
    "coverageDirectory": "../coverage",
    "testEnvironment": "node"
  }
}

```

```ignore
# compiled output
/dist
/node_modules

# Logs
logs
*.log
npm-debug.log*
pnpm-debug.log*
yarn-debug.log*
yarn-error.log*
lerna-debug.log*

# OS
.DS_Store

# Tests
/coverage
/.nyc_output

# IDEs and editors
/.idea
.project
.classpath
.c9/
*.launch
.settings/
*.sublime-workspace

# IDE - VSCode
.vscode/*
!.vscode/settings.json
!.vscode/tasks.json
!.vscode/launch.json
!.vscode/extensions.json

# Environment variables
.env
.env.local
.env.*.local

# Database
*.db
*.db-journal
/prisma/migrations

```

```markdown
# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞ Insurance Chat Backend

## üìã –®–∞–≥ 1: –°–æ–∑–¥–∞–π—Ç–µ .env —Ñ–∞–π–ª

–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `.env` –≤ –ø–∞–ø–∫–µ `backend` —Å–æ —Å–ª–µ–¥—É—é—â–∏–º —Å–æ–¥–µ—Ä–∂–∏–º—ã–º:

```env
DATABASE_URL="file:./dev.db"

TELEGRAM_BOT_TOKEN="8279197548:AAGXNdEXKQUVBoK_qY2D8dAZWjdzSl1qhmQ"

# –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ - –¥–ª—è OpenAI
# OPENAI_API_KEY="your-openai-api-key"
# OPENAI_MODEL="gpt-4o-mini"

JWT_SECRET="your-super-secret-jwt-key-change-this-in-production"
```

## üîß –®–∞–≥ 2: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

```powershell
npm install
```

## üóÑÔ∏è –®–∞–≥ 3: –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö

### –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å Prisma Client:
```powershell
npm run prisma:generate
```

### –°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –ë–î:
```powershell
npm run prisma:migrate
```

–ü—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∏–º–µ–Ω–∏ –º–∏–≥—Ä–∞—Ü–∏–∏ –≤–≤–µ–¥–∏—Ç–µ: `init`

## üöÄ –®–∞–≥ 4: –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä

```powershell
npm run start:dev
```

## üåê –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Telegram Webhook (–¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏)

### –û–∫–Ω–æ ‚Ññ1 - –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ç—É–Ω–Ω–µ–ª—å:
```powershell
npx localtunnel --port 3000
```

–°–∫–æ–ø–∏—Ä—É–π—Ç–µ URL —Ç—É–Ω–Ω–µ–ª—è (–Ω–∞–ø—Ä–∏–º–µ—Ä: `https://tangy-colts-change.loca.lt`)

### –û–∫–Ω–æ ‚Ññ2 - –ù–∞—Å—Ç—Ä–æ–π—Ç–µ webhook:
```powershell
$botToken = "8279197548:AAGXNdEXKQUVBoK_qY2D8dAZWjdzSl1qhmQ"
$publicUrl = "https://–≤–∞—à-url.loca.lt"  # –í—Å—Ç–∞–≤—å—Ç–µ URL –∏–∑ –æ–∫–Ω–∞ ‚Ññ1
Invoke-RestMethod -Uri ("https://api.telegram.org/bot{0}/setWebhook?url={1}/channels/telegram/webhook" -f $botToken, $publicUrl) -Method Get
```

### –û–∫–Ω–æ ‚Ññ3 - –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä:
```powershell
cd backend
npm run start:dev
```

## üõ†Ô∏è –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

### –ü—Ä–æ—Å–º–æ—Ç—Ä –ë–î —á–µ—Ä–µ–∑ Prisma Studio:
```powershell
npm run prisma:studio
```

### –ü–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ –ë–î:
```powershell
# –£–¥–∞–ª–∏—Ç–µ —Ñ–∞–π–ª dev.db –∏ –ø–∞–ø–∫—É prisma/migrations
# –ó–∞—Ç–µ–º –∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–Ω–æ–≤–∞:
npm run prisma:migrate
```

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã

1. –û—Ç–∫—Ä–æ–π—Ç–µ Telegram –±–æ—Ç–∞
2. –ù–∞–ø–∏—à–∏—Ç–µ –ª—é–±–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
3. –ë–æ—Ç –¥–æ–ª–∂–µ–Ω –æ—Ç–≤–µ—Ç–∏—Ç—å
4. –°–æ–æ–±—â–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –ë–î (`dev.db`)

## üìö –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
backend/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ modules/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ai/         # AI —Å–µ—Ä–≤–∏—Å (OpenAI)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth/       # –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∞–≥–µ–Ω—Ç–æ–≤
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ channels/   # Telegram webhook
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ chat/       # –ß–∞—Ç —Å–µ—Ä–≤–∏—Å
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ prisma/     # Prisma –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
‚îÇ   ‚îî‚îÄ‚îÄ main.ts
‚îú‚îÄ‚îÄ prisma/
‚îÇ   ‚îî‚îÄ‚îÄ schema.prisma   # –°—Ö–µ–º–∞ –ë–î
‚îú‚îÄ‚îÄ .env               # –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
‚îî‚îÄ‚îÄ dev.db            # SQLite –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
```

## üîç Troubleshooting

### –û—à–∏–±–∫–∞: "Prisma Client not generated"
```powershell
npm run prisma:generate
```

### –û—à–∏–±–∫–∞: "Can't reach database"
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ `.env` —Ñ–∞–π–ª —Å–æ–∑–¥–∞–Ω
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—É—Ç—å –≤ `DATABASE_URL`

### Webhook –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ç—É–Ω–Ω–µ–ª—å –∑–∞–ø—É—â–µ–Ω
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ URL —Ç—É–Ω–Ω–µ–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –≤ webhook
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫

```

Perfect! –Ø –∑–∞–≤–µ—Ä—à–∏–ª –º–∏–≥—Ä–∞—Ü–∏—é –Ω–∞ Prisma –ë–î. –í–æ—Ç —á—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ:

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ:

### 1. **–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Prisma –∫ –ø—Ä–æ–µ–∫—Ç—É**
   - ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ —Å—Ö–µ–º–∞ –ë–î (–¥–æ–±–∞–≤–ª–µ–Ω–∞ —Å–≤—è–∑—å `KBDoc.chunks`)
   - ‚úÖ –°–æ–∑–¥–∞–Ω `PrismaModule` –∏ `PrismaService` –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î
   - ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω –≤ `AppModule` –∫–∞–∫ –≥–ª–æ–±–∞–ª—å–Ω—ã–π –º–æ–¥—É–ª—å

### 2. **–ú–∏–≥—Ä–∞—Ü–∏—è ChatService –Ω–∞ –ë–î**
   - ‚úÖ –ü–µ—Ä–µ–ø–∏—Å–∞–Ω `ChatService` —Å in-memory –Ω–∞ Prisma
   - ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è User –∏ Session
   - ‚úÖ –í—Å–µ –º–µ—Ç–æ–¥—ã —Ç–µ–ø–µ—Ä—å –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –∏ —Ä–∞–±–æ—Ç–∞—é—Ç —Å —Ä–µ–∞–ª—å–Ω–æ–π –ë–î
   - ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω `TelegramController` –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å async –º–µ—Ç–æ–¥–∞–º–∏

### 3. **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞**
   - ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã Prisma —Å–∫—Ä–∏–ø—Ç—ã –≤ `package.json`
   - ‚úÖ –°–æ–∑–¥–∞–Ω `.gitignore` –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è –ë–î –∏ .env
   - ‚úÖ –°–æ–∑–¥–∞–Ω `SETUP.md` —Å –ø–æ–ª–Ω–æ–π –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–µ–π –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ

---

## üìã –ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –°–ï–ô–ß–ê–°:

### **–®–∞–≥ 1:** –°–æ–∑–¥–∞–π—Ç–µ `.env` —Ñ–∞–π–ª
–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `insurance-chat/backend/.env`:
```env
DATABASE_URL="file:./dev.db"
TELEGRAM_BOT_TOKEN="8279197548:AAGXNdEXKQUVBoK_qY2D8dAZWjdzSl1qhmQ"
JWT_SECRET="your-super-secret-jwt-key"
```

### **–®–∞–≥ 2:** –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –ë–î
–û—Ç–∫—Ä–æ–π—Ç–µ **PowerShell** –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:

```powershell
cd insurance-chat\backend
npm install
npm run prisma:generate
npm run prisma:migrate
```

–ü—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∏–º–µ–Ω–∏ –º–∏–≥—Ä–∞—Ü–∏–∏ –≤–≤–µ–¥–∏—Ç–µ: **`init`**

### **–®–∞–≥ 3:** –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä
```powershell
npm run start:dev
```

---

## üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ —Ä–∞–∑–≤–∏—Ç–∏—è –ø—Ä–æ–µ–∫—Ç–∞:

–ü–æ—Å–ª–µ —Ç–æ–≥–æ –∫–∞–∫ –ë–î –∑–∞—Ä–∞–±–æ—Ç–∞–µ—Ç, –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å:

1. **Knowledge Base (RAG)** - —É–º–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π –æ —Å—Ç—Ä–∞—Ö–æ–≤—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–∞—Ö
2. **–í–µ–±-–≤–∏–¥–∂–µ—Ç** - —á–∞—Ç –¥–ª—è –≤—Å—Ç—Ä–∞–∏–≤–∞–Ω–∏—è –Ω–∞ —Å–∞–π—Ç
3. **–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å** - –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –∞–≥–µ–Ω—Ç–æ–≤ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —á–∞—Ç–∞–º–∏
4. **Handover –º–µ—Ö–∞–Ω–∏–∑–º** - –ø–µ—Ä–µ–¥–∞—á–∞ —á–∞—Ç–∞ –æ—Ç AI –∫ –∂–∏–≤–æ–º—É –∞–≥–µ–Ω—Ç—É
5. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å polis.online** - –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –ø–æ–ª–∏—Å–æ–≤ –ø—Ä—è–º–æ –∏–∑ —á–∞—Ç–∞

–•–æ—Ç–∏—Ç–µ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Å –∫–∞–∫–∏–º-—Ç–æ –∏–∑ —ç—Ç–∏—Ö –ø—É–Ω–∫—Ç–æ–≤? üéØ

```plaintext
DATABASE_URL="file:./dev.db"
TELEGRAM_BOT_TOKEN="8279197548:AAGXNdEXKQUVBoK_qY2D8dAZWjdzSl1qhmQ"
JWT_SECRET="your-super-secret-jwt-key"
```

```plaintext
DATABASE_URL="file:./dev.db"
TELEGRAM_BOT_TOKEN="8279197548:AAGXNdEXKQUVBoK_qY2D8dAZWjdzSl1qhmQ"
JWT_SECRET="your-super-secret-jwt-key"
```

```powershell
cd insurance-chat\backend
npm install
npm run prisma:generate
npm run prisma:migrate
```

```powershell
npm run start:dev
```

---

**User**

–¥–∞–≤–∞–π –ø—Ä–æ–¥–æ–ª–∂–∏–º, –≤—ã–±–µ—Ä–∏ —Å–∞–º

---

**Cursor**

–û—Ç–ª–∏—á–Ω–æ! –Ø –≤—ã–±–µ—Ä—É **Knowledge Base —Å RAG** - —ç—Ç–æ —Å–∞–º–æ–µ –≤–∞–∂–Ω–æ–µ –¥–ª—è —Å—Ç—Ä–∞—Ö–æ–≤–æ–≥–æ –±–æ—Ç–∞. –°–µ–π—á–∞—Å AI –ø—Ä–æ—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –æ–±—â–∏–µ –∑–Ω–∞–Ω–∏—è, –Ω–æ –¥–ª—è —Å—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏—è –Ω—É–∂–Ω—ã —Ç–æ—á–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–∞—Ö.

–ß—Ç–æ —è —Å–¥–µ–ª–∞—é:
1. **KB Service** - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–∑–æ–π –∑–Ω–∞–Ω–∏–π
2. **–í–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫** - —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ –ø–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞–º
3. **RAG –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è** - —É–º–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
4. **Seed –¥–∞–Ω–Ω—ã–µ** - –ø—Ä–∏–º–µ—Ä—ã —Å—Ç—Ä–∞—Ö–æ–≤—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

–ù–∞—á–Ω—ë–º! üöÄ

```typescript
import { Injectable, Logger } from '@nestjs/common';
import { PrismaService } from '../prisma/prisma.service';

interface EmbeddingVector {
  embedding: number[];
}

@Injectable()
export class KbService {
  private readonly logger = new Logger(KbService.name);
  private embeddingsCache = new Map<string, number[]>();

  constructor(private readonly prisma: PrismaService) {}

  /**
   * –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —ç–º–±–µ–¥–¥–∏–Ω–≥–∞ —á–µ—Ä–µ–∑ OpenAI
   */
  private async generateEmbedding(text: string): Promise<number[]> {
    const apiKey = process.env.OPENAI_API_KEY;
    if (!apiKey) {
      this.logger.warn('OPENAI_API_KEY not set, using zero vector');
      return new Array(1536).fill(0); // Default embedding dimension for text-embedding-3-small
    }

    try {
      const response = await fetch('https://api.openai.com/v1/embeddings', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          Authorization: `Bearer ${apiKey}`,
        },
        body: JSON.stringify({
          model: 'text-embedding-3-small',
          input: text,
        }),
      });

      if (!response.ok) {
        throw new Error(`OpenAI API error: ${response.status}`);
      }

      const data = (await response.json()) as { data: EmbeddingVector[] };
      return data.data[0].embedding;
    } catch (error: any) {
      this.logger.error('Failed to generate embedding', error?.stack || String(error));
      return new Array(1536).fill(0);
    }
  }

  /**
   * –ö–æ—Å–∏–Ω—É—Å–Ω–æ–µ —Å—Ö–æ–¥—Å—Ç–≤–æ –º–µ–∂–¥—É –≤–µ–∫—Ç–æ—Ä–∞–º–∏
   */
  private cosineSimilarity(vecA: number[], vecB: number[]): number {
    if (vecA.length !== vecB.length) return 0;

    let dotProduct = 0;
    let normA = 0;
    let normB = 0;

    for (let i = 0; i < vecA.length; i++) {
      dotProduct += vecA[i] * vecB[i];
      normA += vecA[i] * vecA[i];
      normB += vecB[i] * vecB[i];
    }

    if (normA === 0 || normB === 0) return 0;
    return dotProduct / (Math.sqrt(normA) * Math.sqrt(normB));
  }

  /**
   * –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –≤ –±–∞–∑—É –∑–Ω–∞–Ω–∏–π
   */
  async addDocument(params: {
    companyCode: string;
    productCode: string;
    title: string;
    content: string;
    fileUrl?: string;
    sourceUrl?: string;
    version?: string;
  }): Promise<{ docId: string; chunksCount: number }> {
    const { companyCode, productCode, title, content, fileUrl, sourceUrl, version } = params;

    // –†–∞–∑–±–∏–≤–∞–µ–º –¥–æ–∫—É–º–µ–Ω—Ç –Ω–∞ —á–∞–Ω–∫–∏ (–ø–æ 500 —Å–∏–º–≤–æ–ª–æ–≤ —Å –ø–µ—Ä–µ–∫—Ä—ã—Ç–∏–µ–º 50)
    const chunks = this.splitIntoChunks(content, 500, 50);

    // –°–æ–∑–¥–∞—ë–º –¥–æ–∫—É–º–µ–Ω—Ç
    const doc = await this.prisma.kBDoc.create({
      data: {
        companyCode,
        productCode,
        title,
        fileUrl,
        sourceUrl,
        version,
      },
    });

    // –°–æ–∑–¥–∞—ë–º —á–∞–Ω–∫–∏
    for (let i = 0; i < chunks.length; i++) {
      await this.prisma.kBChunk.create({
        data: {
          docId: doc.id,
          chunkIdx: i,
          text: chunks[i],
        },
      });
    }

    this.logger.log(`Added document ${doc.id} with ${chunks.length} chunks`);

    return {
      docId: doc.id,
      chunksCount: chunks.length,
    };
  }

  /**
   * –†–∞–∑–±–∏–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –Ω–∞ —á–∞–Ω–∫–∏
   */
  private splitIntoChunks(text: string, chunkSize: number, overlap: number): string[] {
    const chunks: string[] = [];
    let start = 0;

    while (start < text.length) {
      const end = Math.min(start + chunkSize, text.length);
      chunks.push(text.substring(start, end));
      start += chunkSize - overlap;
    }

    return chunks;
  }

  /**
   * –°–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ –ø–æ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π
   */
  async search(params: {
    query: string;
    companyCode?: string;
    productCode?: string;
    limit?: number;
  }): Promise<Array<{ text: string; score: number; docTitle: string; companyCode: string; productCode: string }>> {
    const { query, companyCode, productCode, limit = 5 } = params;

    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —ç–º–±–µ–¥–¥–∏–Ω–≥ –∑–∞–ø—Ä–æ—Å–∞
    const queryEmbedding = await this.generateEmbedding(query);

    // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —á–∞–Ω–∫–∏ (—Å —Ñ–∏–ª—å—Ç—Ä–æ–º –ø–æ –∫–æ–º–ø–∞–Ω–∏–∏/–ø—Ä–æ–¥—É–∫—Ç—É –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω–æ)
    const chunks = await this.prisma.kBChunk.findMany({
      include: {
        doc: true,
      },
      where: {
        doc: {
          ...(companyCode && { companyCode }),
          ...(productCode && { productCode }),
        },
      },
    });

    // –ï—Å–ª–∏ —á–∞–Ω–∫–æ–≤ –Ω–µ—Ç, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    if (chunks.length === 0) {
      return [];
    }

    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —ç–º–±–µ–¥–¥–∏–Ω–≥–∏ –¥–ª—è —á–∞–Ω–∫–æ–≤ –∏ –≤—ã—á–∏—Å–ª—è–µ–º —Å—Ö–æ–¥—Å—Ç–≤–æ
    const results = await Promise.all(
      chunks.map(async (chunk) => {
        const cacheKey = `${chunk.id}`;
        let chunkEmbedding = this.embeddingsCache.get(cacheKey);

        if (!chunkEmbedding) {
          chunkEmbedding = await this.generateEmbedding(chunk.text);
          this.embeddingsCache.set(cacheKey, chunkEmbedding);
        }

        const score = this.cosineSimilarity(queryEmbedding, chunkEmbedding);

        return {
          text: chunk.text,
          score,
          docTitle: chunk.doc.title,
          companyCode: chunk.doc.companyCode,
          productCode: chunk.doc.productCode,
        };
      }),
    );

    // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —Å—Ö–æ–¥—Å—Ç–≤—É –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–æ–ø —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    return results.sort((a, b) => b.score - a.score).slice(0, limit);
  }

  /**
   * –ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
   */
  async listDocuments(params?: { companyCode?: string; productCode?: string }) {
    return this.prisma.kBDoc.findMany({
      where: {
        ...(params?.companyCode && { companyCode: params.companyCode }),
        ...(params?.productCode && { productCode: params.productCode }),
      },
      include: {
        _count: {
          select: { chunks: true },
        },
      },
      orderBy: {
        createdAt: 'desc',
      },
    });
  }

  /**
   * –£–¥–∞–ª–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞
   */
  async deleteDocument(docId: string) {
    // –£–¥–∞–ª—è–µ–º —á–∞–Ω–∫–∏
    await this.prisma.kBChunk.deleteMany({
      where: { docId },
    });

    // –£–¥–∞–ª—è–µ–º –¥–æ–∫—É–º–µ–Ω—Ç
    await this.prisma.kBDoc.delete({
      where: { id: docId },
    });

    // –û—á–∏—â–∞–µ–º –∫–µ—à —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤
    this.embeddingsCache.clear();

    this.logger.log(`Deleted document ${docId}`);
  }
}

```

```typescript
import { Module } from '@nestjs/common';
import { KbService } from './kb.service';
import { KbController } from './kb.controller';

@Module({
  providers: [KbService],
  controllers: [KbController],
  exports: [KbService],
})
export class KbModule {}

```

```typescript
import { Body, Controller, Delete, Get, Param, Post, Query } from '@nestjs/common';
import { KbService } from './kb.service';

@Controller('kb')
export class KbController {
  constructor(private readonly kb: KbService) {}

  /**
   * POST /kb/documents - –î–æ–±–∞–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç
   */
  @Post('documents')
  async addDocument(
    @Body()
    body: {
      companyCode: string;
      productCode: string;
      title: string;
      content: string;
      fileUrl?: string;
      sourceUrl?: string;
      version?: string;
    },
  ) {
    return this.kb.addDocument(body);
  }

  /**
   * GET /kb/documents - –°–ø–∏—Å–æ–∫ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
   */
  @Get('documents')
  async listDocuments(@Query('companyCode') companyCode?: string, @Query('productCode') productCode?: string) {
    return this.kb.listDocuments({ companyCode, productCode });
  }

  /**
   * DELETE /kb/documents/:id - –£–¥–∞–ª–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç
   */
  @Delete('documents/:id')
  async deleteDocument(@Param('id') id: string) {
    await this.kb.deleteDocument(id);
    return { success: true };
  }

  /**
   * POST /kb/search - –ü–æ–∏—Å–∫ –ø–æ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π
   */
  @Post('search')
  async search(
    @Body()
    body: {
      query: string;
      companyCode?: string;
      productCode?: string;
      limit?: number;
    },
  ) {
    return this.kb.search(body);
  }
}

```

```typescript
import { Module } from '@nestjs/common';
import { AppController } from './app.controller';
import { AppService } from './app.service';
import { ChatModule } from './modules/chat/chat.module';
import { AuthModule } from './modules/auth/auth.module';
import { ChannelsModule } from './modules/channels/channels.module';
import { PrismaModule } from './modules/prisma/prisma.module';
import { KbModule } from './modules/kb/kb.module';

@Module({
  imports: [PrismaModule, ChatModule, AuthModule, ChannelsModule, KbModule],
  controllers: [AppController],
  providers: [AppService],
})
export class AppModule {}

```

```typescript
import { Injectable, Logger } from '@nestjs/common';
import { KbService } from '../kb/kb.service';

@Injectable()
export class AiService {
  private readonly logger = new Logger(AiService.name);

  constructor(private readonly kb: KbService) {}

  async generateReply(userText: string, options?: { useRAG?: boolean }): Promise<string> {
    const apiKey = process.env.OPENAI_API_KEY;
    const model = process.env.OPENAI_MODEL || 'gpt-4o-mini';
    const useRAG = options?.useRAG ?? true; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏—Å–ø–æ–ª—å–∑—É–µ–º RAG

    // Fallback: simple heuristic answer if no API key configured
    if (!apiKey) {
      return `–ü–æ–Ω—è–ª –∑–∞–ø—Ä–æ—Å: "${userText}". –°–µ–π—á–∞—Å —ç—Ç–æ —Ç–µ—Å—Ç–æ–≤—ã–π –∞–≤—Ç–æ–æ—Ç–≤–µ—Ç. –£—Ç–æ—á–Ω–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, —á—Ç–æ –∏–º–µ–Ω–Ω–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ñ–æ—Ä–º–∏—Ç—å –∏–ª–∏ —É–∑–Ω–∞—Ç—å –ø–æ —Å—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏—é?`;
    }

    try {
      let systemPrompt = '–¢—ã —Å—Ç—Ä–∞—Ö–æ–≤–æ–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –¥–ª—è –∫–∏—Ç–∞–π—Å–∫–∏—Ö —Å—Ç—Ä–∞—Ö–æ–≤—ã—Ö –∫–æ–º–ø–∞–Ω–∏–π. –û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ –∏ –ø–æ –¥–µ–ª—É, –¥—Ä—É–∂–µ–ª—é–±–Ω–æ, –Ω–∞ —Ä—É—Å—Å–∫–æ–º.';
      let context = '';

      // RAG: –ü–æ–∏—Å–∫ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π
      if (useRAG) {
        const results = await this.kb.search({
          query: userText,
          limit: 3,
        });

        if (results.length > 0) {
          context = results
            .map((r, i) => `[–î–æ–∫—É–º–µ–Ω—Ç ${i + 1}: ${r.docTitle} (${r.companyCode}/${r.productCode})]\n${r.text}`)
            .join('\n\n');

          systemPrompt = `–¢—ã —Å—Ç—Ä–∞—Ö–æ–≤–æ–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –¥–ª—è –∫–∏—Ç–∞–π—Å–∫–∏—Ö —Å—Ç—Ä–∞—Ö–æ–≤—ã—Ö –∫–æ–º–ø–∞–Ω–∏–π. 
–û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ –∏ –ø–æ –¥–µ–ª—É, –¥—Ä—É–∂–µ–ª—é–±–Ω–æ, –Ω–∞ —Ä—É—Å—Å–∫–æ–º.
–ò—Å–ø–æ–ª—å–∑—É–π –¢–û–õ–¨–ö–û –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ –ø—Ä–∏–≤–µ–¥–µ–Ω–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –¥–ª—è –æ—Ç–≤–µ—Ç–∞.
–ï—Å–ª–∏ –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö –Ω–µ—Ç –Ω—É–∂–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏, —á–µ—Å—Ç–Ω–æ —Å–∫–∞–∂–∏ –æ–± —ç—Ç–æ–º –∏ –ø—Ä–µ–¥–ª–æ–∂–∏ —Å–≤—è–∑–∞—Ç—å—Å—è —Å –∞–≥–µ–Ω—Ç–æ–º.

=== –ë–ê–ó–ê –ó–ù–ê–ù–ò–ô ===
${context}
===================`;

          this.logger.log(`RAG found ${results.length} relevant chunks for query: "${userText}"`);
        } else {
          this.logger.log(`RAG: no relevant documents found for query: "${userText}"`);
          systemPrompt += '\n–í –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π –ø–æ–∫–∞ –Ω–µ—Ç —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏. –î–∞–π –æ–±—â–∏–π –æ—Ç–≤–µ—Ç –∏ –ø—Ä–µ–¥–ª–æ–∂–∏ —Å–≤—è–∑–∞—Ç—å—Å—è —Å –∞–≥–µ–Ω—Ç–æ–º –¥–ª—è –¥–µ—Ç–∞–ª–µ–π.';
        }
      }

      const response = await fetch('https://api.openai.com/v1/chat/completions', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          Authorization: `Bearer ${apiKey}`,
        },
        body: JSON.stringify({
          model,
          messages: [
            { role: 'system', content: systemPrompt },
            { role: 'user', content: userText },
          ],
          temperature: 0.3,
          max_tokens: 500,
        }),
      });

      if (!response.ok) {
        const text = await response.text();
        this.logger.warn(`OpenAI error: ${response.status} ${text}`);
        return '–°–ø–∞—Å–∏–±–æ –∑–∞ –≤–æ–ø—Ä–æ—Å! –°–µ–π—á–∞—Å –º–Ω–æ–≥–æ –æ–±—Ä–∞—â–µ–Ω–∏–π, —É—Ç–æ—á–Ω–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –¥–µ—Ç–∞–ª–∏, –∏ —è –æ—Ç–≤–µ—á—É.';
      }

      const data = (await response.json()) as any;
      const content = data?.choices?.[0]?.message?.content?.trim();
      return content || '–°–ø–∞—Å–∏–±–æ –∑–∞ –≤–æ–ø—Ä–æ—Å! –ú–æ–≥—É —É—Ç–æ—á–Ω–∏—Ç—å –¥–µ—Ç–∞–ª–∏, —á—Ç–æ–±—ã –ø–æ–º–æ—á—å —Ç–æ—á–Ω–µ–µ?';
    } catch (err: any) {
      this.logger.error('AI request failed', err?.stack || String(err));
      return '–°–µ—Ä–≤–∏—Å –∞–≤—Ç–æ–æ—Ç–≤–µ—Ç–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–ø—Ä–æ—Å–∏—Ç—å –∏–Ω–∞—á–µ –∏–ª–∏ –ø–æ–∑–≤–∞—Ç—å –∞–≥–µ–Ω—Ç–∞.';
    }
  }
}




```

–¢–µ–ø–µ—Ä—å –Ω—É–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å –º–æ–¥—É–ª—å AI, —á—Ç–æ–±—ã –æ–Ω –º–æ–≥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å KB —Å–µ—Ä–≤–∏—Å:

```typescript
import { Module } from '@nestjs/common';
import { TelegramController } from './telegram.controller';
import { ChatModule } from '../chat/chat.module';
import { KbModule } from '../kb/kb.module';
import { AiService } from '../ai/ai.service';

@Module({
  imports: [ChatModule, KbModule],
  controllers: [TelegramController],
  providers: [AiService],
})
export class ChannelsModule {}



```

–û—Ç–ª–∏—á–Ω–æ! –¢–µ–ø–µ—Ä—å —Å–æ–∑–¥–∞–º seed –¥–∞–Ω–Ω—ã–µ —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏ —Å—Ç—Ä–∞—Ö–æ–≤—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤:

```typescript
import { PrismaClient } from '@prisma/client';

const prisma = new PrismaClient();

const sampleDocuments = [
  {
    companyCode: 'PICC',
    productCode: 'TRAVEL_ANNUAL',
    title: '–ì–æ–¥–æ–≤–æ–π —Å—Ç—Ä–∞—Ö–æ–≤–æ–π –ø–æ–ª–∏—Å –¥–ª—è —Ç—É—Ä–∏—Å—Ç–æ–≤ –≤ –ö–∏—Ç–∞–π',
    content: `–ì–æ–¥–æ–≤–æ–π —Ç—É—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–ª–∏—Å PICC –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –∫–æ–º–ø–ª–µ–∫—Å–Ω—É—é –∑–∞—â–∏—Ç—É –ø—Ä–∏ –ø–æ–µ–∑–¥–∫–∞—Ö –≤ –ö–∏—Ç–∞–π –Ω–∞ –≤–µ—Å—å –≥–æ–¥.

–û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–∫—Ä—ã—Ç–∏—è:
- –ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ —Ä–∞—Å—Ö–æ–¥—ã: –¥–æ 500,000 —é–∞–Ω–µ–π
- –ì–æ—Å–ø–∏—Ç–∞–ª–∏–∑–∞—Ü–∏—è: –ø–æ–ª–Ω–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ
- –≠–∫—Å—Ç—Ä–µ–Ω–Ω–∞—è —ç–≤–∞–∫—É–∞—Ü–∏—è: –≤–∫–ª—é—á–µ–Ω–∞
- –ë–∞–≥–∞–∂: –¥–æ 20,000 —é–∞–Ω–µ–π
- –û—Ç–º–µ–Ω–∞ –ø–æ–µ–∑–¥–∫–∏: –¥–æ 50,000 —é–∞–Ω–µ–π

–°—Ç–æ–∏–º–æ—Å—Ç—å: –æ—Ç 2,500 —é–∞–Ω–µ–π –≤ –≥–æ–¥

–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:
- –ù–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–µ–∑–¥–æ–∫ –≤ –≥–æ–¥
- –ö–∞–∂–¥–∞—è –ø–æ–µ–∑–¥–∫–∞ –¥–æ 90 –¥–Ω–µ–π
- –ö—Ä—É–≥–ª–æ—Å—É—Ç–æ—á–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ
- –û–Ω–ª–∞–π–Ω –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞ 5 –º–∏–Ω—É—Ç

–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
- –í–æ–∑—Ä–∞—Å—Ç: 18-70 –ª–µ—Ç
- –†–æ—Å—Å–∏–π—Å–∫–æ–µ –≥—Ä–∞–∂–¥–∞–Ω—Å—Ç–≤–æ
- –î–µ–π—Å—Ç–≤—É—é—â–∏–π –∑–∞–≥—Ä–∞–Ω–ø–∞—Å–ø–æ—Ä—Ç`,
  },
  {
    companyCode: 'CPIC',
    productCode: 'MEDICAL_PREMIUM',
    title: '–ü—Ä–µ–º–∏—É–º –º–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–µ —Å—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏–µ CPIC',
    content: `–ü—Ä–µ–º–∏—É–º –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π –ø–æ–ª–∏—Å CPIC - –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞ –∑–¥–æ—Ä–æ–≤—å—è –≤ –ö–∏—Ç–∞–µ.

–ü–æ–∫—Ä—ã—Ç–∏–µ:
- –ê–º–±—É–ª–∞—Ç–æ—Ä–Ω–æ–µ –ª–µ—á–µ–Ω–∏–µ: –¥–æ 100,000 —é–∞–Ω–µ–π/–≥–æ–¥
- –°—Ç–∞—Ü–∏–æ–Ω–∞—Ä–Ω–æ–µ –ª–µ—á–µ–Ω–∏–µ: –¥–æ 1,000,000 —é–∞–Ω–µ–π/–≥–æ–¥
- –°—Ç–æ–º–∞—Ç–æ–ª–æ–≥–∏—è: –¥–æ 30,000 —é–∞–Ω–µ–π/–≥–æ–¥
- –¢—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω–∞—è –∫–∏—Ç–∞–π—Å–∫–∞—è –º–µ–¥–∏—Ü–∏–Ω–∞: –≤–∫–ª—é—á–µ–Ω–∞
- –ü–ª–∞–Ω–æ–≤—ã–µ –æ—Å–º–æ—Ç—Ä—ã: 2 —Ä–∞–∑–∞ –≤ –≥–æ–¥ –±–µ—Å–ø–ª–∞—Ç–Ω–æ

–°—Ç–æ–∏–º–æ—Å—Ç—å: –æ—Ç 8,000 —é–∞–Ω–µ–π –≤ –≥–æ–¥

–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:
- –ü—Ä—è–º—ã–µ —Ä–∞—Å—á–µ—Ç—ã —Å –∫–ª–∏–Ω–∏–∫–∞–º–∏ (cashless)
- –î–æ—Å—Ç—É–ø –∫ –ª—É—á—à–∏–º –≥–æ—Å–ø–∏—Ç–∞–ª—è–º –ö–∏—Ç–∞—è
- –õ–∏—á–Ω—ã–π –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä
- –¢–µ–ª–µ–º–µ–¥–∏—Ü–∏–Ω–∞ 24/7 –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ
- –ü–æ–∫—Ä—ã—Ç–∏–µ —Ö—Ä–æ–Ω–∏—á–µ—Å–∫–∏—Ö –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏–π

–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ–ø—Ü–∏–∏:
- –ú–∞—Ç–µ—Ä–∏–Ω—Å—Ç–≤–æ –∏ —Ä–æ–¥—ã: +3,000 —é–∞–Ω–µ–π
- –°—Ç–æ–º–∞—Ç–æ–ª–æ–≥–∏—è —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è: +2,000 —é–∞–Ω–µ–π
- –ó—Ä–µ–Ω–∏–µ (–æ—á–∫–∏, –ª–∏–Ω–∑—ã): +1,500 —é–∞–Ω–µ–π`,
  },
  {
    companyCode: 'PING_AN',
    productCode: 'AUTO_STANDARD',
    title: '–ê–≤—Ç–æ—Å—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏–µ Ping An - –°—Ç–∞–Ω–¥–∞—Ä—Ç',
    content: `–ö–æ–º–ø–ª–µ–∫—Å–Ω–æ–µ –∞–≤—Ç–æ—Å—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏–µ Ping An –∑–∞—â–∏—Ç–∏—Ç –≤–∞—à –∞–≤—Ç–æ–º–æ–±–∏–ª—å –≤ –ö–∏—Ç–∞–µ.

–í–∏–¥—ã –ø–æ–∫—Ä—ã—Ç–∏—è:
1. –û–°–ê–ì–û (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ):
   - –£—â–µ—Ä–± —Ç—Ä–µ—Ç—å–∏–º –ª–∏—Ü–∞–º: –¥–æ 200,000 —é–∞–Ω–µ–π
   - –ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ —Ä–∞—Å—Ö–æ–¥—ã: –¥–æ 18,000 —é–∞–Ω–µ–π
   - –£—â–µ—Ä–± –∏–º—É—â–µ—Å—Ç–≤—É: –¥–æ 2,000 —é–∞–Ω–µ–π

2. –ö–ê–°–ö–û (–¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è):
   - –ü–æ–ª–Ω–∞—è –≥–∏–±–µ–ª—å/–∫—Ä–∞–∂–∞: —Ä—ã–Ω–æ—á–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –∞–≤—Ç–æ
   - –ß–∞—Å—Ç–∏—á–Ω—ã–µ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏—è: –ø–æ–ª–Ω–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ —Ä–µ–º–æ–Ω—Ç–∞
   - –°—Ç–∏—Ö–∏–π–Ω—ã–µ –±–µ–¥—Å—Ç–≤–∏—è: –≤–∫–ª—é—á–µ–Ω—ã
   - –°—Ç–µ–∫–ª–∞ –∏ —Ñ–∞—Ä—ã: –æ—Ç–¥–µ–ª—å–Ω–∞—è –æ–ø—Ü–∏—è

–°—Ç–æ–∏–º–æ—Å—Ç—å –û–°–ê–ì–û: –æ—Ç 950 —é–∞–Ω–µ–π/–≥–æ–¥
–°—Ç–æ–∏–º–æ—Å—Ç—å –ö–ê–°–ö–û: 3-5% –æ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª—è

–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏:
- –≠–≤–∞–∫—É–∞—Ü–∏—è –ø—Ä–∏ –î–¢–ü: –±–µ—Å–ø–ª–∞—Ç–Ω–æ
- –ü–æ–º–æ—â—å –Ω–∞ –¥–æ—Ä–æ–≥–µ: 24/7
- –ó–∞–º–µ–Ω–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª—è –Ω–∞ –≤—Ä–µ–º—è —Ä–µ–º–æ–Ω—Ç–∞: –æ–ø—Ü–∏—è
- –Æ—Ä–∏–¥–∏—á–µ—Å–∫–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –ø—Ä–∏ –î–¢–ü: –≤–∫–ª—é—á–µ–Ω–∞

–°–∫–∏–¥–∫–∏:
- –ë–µ–∑ –î–¢–ü 1 –≥–æ–¥: -10%
- –ë–µ–∑ –î–¢–ü 2 –≥–æ–¥–∞: -20%
- –ë–µ–∑ –î–¢–ü 3+ –≥–æ–¥–∞: -30%`,
  },
  {
    companyCode: 'PICC',
    productCode: 'PROPERTY_HOME',
    title: '–°—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏–µ –∫–≤–∞—Ä—Ç–∏—Ä—ã PICC',
    content: `–ó–∞—â–∏—Ç–∏—Ç–µ —Å–≤–æ—é –∫–≤–∞—Ä—Ç–∏—Ä—É –≤ –ö–∏—Ç–∞–µ —Å –ø–æ–ª–∏—Å–æ–º PICC.

–ß—Ç–æ –ø–æ–∫—Ä—ã–≤–∞–µ—Ç—Å—è:
- –ü–æ–∂–∞—Ä –∏ –≤–∑—Ä—ã–≤: –¥–æ 2,000,000 —é–∞–Ω–µ–π
- –ó–∞—Ç–æ–ø–ª–µ–Ω–∏–µ: –¥–æ 500,000 —é–∞–Ω–µ–π
- –ö—Ä–∞–∂–∞ —Å–æ –≤–∑–ª–æ–º–æ–º: –¥–æ 300,000 —é–∞–Ω–µ–π
- –°—Ç–∏—Ö–∏–π–Ω—ã–µ –±–µ–¥—Å—Ç–≤–∏—è: –¥–æ 1,000,000 —é–∞–Ω–µ–π
- –£—â–µ—Ä–± –∏–º—É—â–µ—Å—Ç–≤—É —Å–æ—Å–µ–¥–µ–π: –¥–æ 500,000 —é–∞–Ω–µ–π

–°—Ç–æ–∏–º–æ—Å—Ç—å: –æ—Ç 800 —é–∞–Ω–µ–π/–≥–æ–¥ (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç –ø–ª–æ—â–∞–¥–∏)

–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ —Å—Ç—Ä–∞—Ö—É–µ—Ç—Å—è:
- –ú–µ–±–µ–ª—å –∏ –±—ã—Ç–æ–≤–∞—è —Ç–µ—Ö–Ω–∏–∫–∞
- –õ–∏—á–Ω—ã–µ –≤–µ—â–∏
- –†–µ–º–æ–Ω—Ç –∏ –æ—Ç–¥–µ–ª–∫–∞
- –ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏ (—Ç—Ä—É–±—ã, –ø—Ä–æ–≤–æ–¥–∫–∞)

–°–µ—Ä–≤–∏—Å—ã:
- –ê–≤–∞—Ä–∏–π–Ω–∞—è —Å–ª—É–∂–±–∞ 24/7
- –ù–µ–∑–∞–≤–∏—Å–∏–º–∞—è –æ—Ü–µ–Ω–∫–∞ —É—â–µ—Ä–±–∞
- –û–ø–ª–∞—Ç–∞ –∑–∞ —Ä–µ–º–æ–Ω—Ç –Ω–∞–ø—Ä—è–º—É—é –ø–æ–¥—Ä—è–¥—á–∏–∫–∞–º
- –í—Ä–µ–º–µ–Ω–Ω–æ–µ –∂–∏–ª—å–µ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ —Ä–µ–º–æ–Ω—Ç–∞

–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
- –ù–∞–ª–∏—á–∏–µ —Å–∏—Å—Ç–µ–º –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
- –†–µ–≥—É–ª—è—Ä–Ω–æ–µ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–π
- –ö–≤–∞—Ä—Ç–∏—Ä–∞ –Ω–µ –Ω–∞ –ø–µ—Ä–≤–æ–º —ç—Ç–∞–∂–µ (–¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç –∫—Ä–∞–∂–∏)`,
  },
  {
    companyCode: 'CPIC',
    productCode: 'BUSINESS_SME',
    title: '–°—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏–µ –±–∏–∑–Ω–µ—Å–∞ CPIC –¥–ª—è –º–∞–ª—ã—Ö –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–π',
    content: `–ö–æ–º–ø–ª–µ–∫—Å–Ω–∞—è –∑–∞—â–∏—Ç–∞ –≤–∞—à–µ–≥–æ –±–∏–∑–Ω–µ—Å–∞ –≤ –ö–∏—Ç–∞–µ —Å CPIC.

–ë–∞–∑–æ–≤–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ:
- –ò–º—É—â–µ—Å—Ç–≤–æ –∫–æ–º–ø–∞–Ω–∏–∏: –¥–æ 5,000,000 —é–∞–Ω–µ–π
- –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å –ø–µ—Ä–µ–¥ —Ç—Ä–µ—Ç—å–∏–º–∏ –ª–∏—Ü–∞–º–∏: –¥–æ 2,000,000 —é–∞–Ω–µ–π
- –ü–µ—Ä–µ—Ä—ã–≤ –≤ –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏: –¥–æ 1,000,000 —é–∞–Ω–µ–π
- –≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ: –¥–æ 500,000 —é–∞–Ω–µ–π

–°—Ç–æ–∏–º–æ—Å—Ç—å: –æ—Ç 15,000 —é–∞–Ω–µ–π/–≥–æ–¥ (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç –æ—Ç—Ä–∞—Å–ª–∏)

–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–∫—Ä—ã—Ç–∏—è:
- –ö–∏–±–µ—Ä-—Ä–∏—Å–∫–∏: –∑–∞—â–∏—Ç–∞ –¥–∞–Ω–Ω—ã—Ö, –≤–∑–ª–æ–º—ã
- –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∞
- –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–∞—è –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å
- –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –≥—Ä—É–∑–æ–≤

–û—Ç—Ä–∞—Å–ª–∏:
- –¢–æ—Ä–≥–æ–≤–ª—è
- IT –∏ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏
- –ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ
- –£—Å–ª—É–≥–∏
- HoReCa

–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:
- –ë—ã—Å—Ç—Ä–æ–µ —É—Ä–µ–≥—É–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —É–±—ã—Ç–∫–æ–≤ (–¥–æ 7 –¥–Ω–µ–π)
- –Æ—Ä–∏–¥–∏—á–µ—Å–∫–æ–µ —Å–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏–µ
- –ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ –ø–æ —Ä–∏—Å–∫–∞–º
- –û–Ω–ª–∞–π–Ω-–∫–∞–±–∏–Ω–µ—Ç –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª–∏—Å–æ–º

–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –±–∏–∑–Ω–µ—Å–∞ –≤ –ö–∏—Ç–∞–µ
- –ì–æ–¥–æ–≤–æ–π –æ–±–æ—Ä–æ—Ç –¥–æ 50 –º–ª–Ω —é–∞–Ω–µ–π
- –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —É–±—ã—Ç–∫–æ–≤ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 –≥–æ–¥–∞ (–∂–µ–ª–∞—Ç–µ–ª—å–Ω–æ)`,
  },
];

async function seed() {
  console.log('üå± Starting seed...');

  // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ
  console.log('üóëÔ∏è  Cleaning old data...');
  await prisma.kBChunk.deleteMany();
  await prisma.kBDoc.deleteMany();

  // –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –∞–≥–µ–Ω—Ç–∞
  console.log('üë§ Creating test agent...');
  const agent = await prisma.agent.upsert({
    where: { login: 'admin' },
    update: {},
    create: {
      name: '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä',
      login: 'admin',
      password: 'admin123', // –í –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –Ω—É–∂–µ–Ω —Ö–µ—à!
      status: 'online',
      companies: 'PICC,CPIC,PING_AN',
    },
  });
  console.log('‚úÖ Agent created:', agent.login);

  // –î–æ–±–∞–≤–ª—è–µ–º –¥–æ–∫—É–º–µ–Ω—Ç—ã –≤ –±–∞–∑—É –∑–Ω–∞–Ω–∏–π
  console.log('üìö Adding knowledge base documents...');
  for (const doc of sampleDocuments) {
    // –†–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ —á–∞–Ω–∫–∏
    const chunks = splitIntoChunks(doc.content, 500, 50);

    const kbDoc = await prisma.kBDoc.create({
      data: {
        companyCode: doc.companyCode,
        productCode: doc.productCode,
        title: doc.title,
        version: '1.0',
      },
    });

    for (let i = 0; i < chunks.length; i++) {
      await prisma.kBChunk.create({
        data: {
          docId: kbDoc.id,
          chunkIdx: i,
          text: chunks[i],
        },
      });
    }

    console.log(`‚úÖ Added: ${doc.title} (${chunks.length} chunks)`);
  }

  console.log('‚ú® Seed completed successfully!');
}

function splitIntoChunks(text: string, chunkSize: number, overlap: number): string[] {
  const chunks: string[] = [];
  let start = 0;

  while (start < text.length) {
    const end = Math.min(start + chunkSize, text.length);
    chunks.push(text.substring(start, end));
    start += chunkSize - overlap;
  }

  return chunks;
}

seed()
  .catch((e) => {
    console.error('‚ùå Seed failed:', e);
    process.exit(1);
  })
  .finally(async () => {
    await prisma.$disconnect();
  });

```

```json
{
  "name": "backend",
  "version": "0.0.1",
  "description": "",
  "author": "",
  "private": true,
  "license": "UNLICENSED",
  "scripts": {
    "build": "nest build",
    "format": "prettier --write \"src/**/*.ts\" \"test/**/*.ts\"",
    "start": "nest start",
    "start:dev": "nest start --watch",
    "start:debug": "nest start --debug --watch",
    "start:prod": "node dist/main",
    "lint": "eslint \"{src,apps,libs,test}/**/*.ts\" --fix",
    "test": "jest",
    "test:watch": "jest --watch",
    "test:cov": "jest --coverage",
    "test:debug": "node --inspect-brk -r tsconfig-paths/register -r ts-node/register node_modules/.bin/jest --runInBand",
    "test:e2e": "jest --config ./test/jest-e2e.json",
    "prisma:generate": "prisma generate",
    "prisma:migrate": "prisma migrate dev",
    "prisma:studio": "prisma studio",
    "prisma:seed": "ts-node prisma/seed.ts"
  },
  "dependencies": {
    "@nestjs/common": "^11.0.1",
    "@nestjs/config": "^4.0.2",
    "@nestjs/core": "^11.0.1",
    "@nestjs/jwt": "^11.0.0",
    "@nestjs/passport": "^11.0.5",
    "@nestjs/platform-express": "^11.0.1",
    "@prisma/client": "^6.16.2",
    "passport": "^0.7.0",
    "passport-jwt": "^4.0.1",
    "prisma": "^6.16.2",
    "reflect-metadata": "^0.2.2",
    "rxjs": "^7.8.1"
  },
  "devDependencies": {
    "@eslint/eslintrc": "^3.2.0",
    "@eslint/js": "^9.18.0",
    "@nestjs/cli": "^11.0.0",
    "@nestjs/schematics": "^11.0.0",
    "@nestjs/testing": "^11.0.1",
    "@types/express": "^5.0.0",
    "@types/jest": "^30.0.0",
    "@types/node": "^22.10.7",
    "@types/passport-jwt": "^4.0.1",
    "@types/supertest": "^6.0.2",
    "eslint": "^9.18.0",
    "eslint-config-prettier": "^10.0.1",
    "eslint-plugin-prettier": "^5.2.2",
    "globals": "^16.0.0",
    "jest": "^30.0.0",
    "prettier": "^3.4.2",
    "source-map-support": "^0.5.21",
    "supertest": "^7.0.0",
    "ts-jest": "^29.2.5",
    "ts-loader": "^9.5.2",
    "ts-node": "^10.9.2",
    "tsconfig-paths": "^4.2.0",
    "typescript": "^5.7.3",
    "typescript-eslint": "^8.20.0"
  },
  "jest": {
    "moduleFileExtensions": [
      "js",
      "json",
      "ts"
    ],
    "rootDir": "src",
    "testRegex": ".*\\.spec\\.ts$",
    "transform": {
      "^.+\\.(t|j)s$": "ts-jest"
    },
    "collectCoverageFrom": [
      "**/*.(t|j)s"
    ],
    "coverageDirectory": "../coverage",
    "testEnvironment": "node"
  }
}

```

–¢–µ–ø–µ—Ä—å –æ–±–Ω–æ–≤–ª—é –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –ø–æ —É—Å—Ç–∞–Ω–æ–≤–∫–µ:

```markdown
# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞ Insurance Chat Backend

## üìã –®–∞–≥ 1: –°–æ–∑–¥–∞–π—Ç–µ .env —Ñ–∞–π–ª

–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `.env` –≤ –ø–∞–ø–∫–µ `backend` —Å–æ —Å–ª–µ–¥—É—é—â–∏–º —Å–æ–¥–µ—Ä–∂–∏–º—ã–º:

```env
DATABASE_URL="file:./dev.db"

TELEGRAM_BOT_TOKEN="8279197548:AAGXNdEXKQUVBoK_qY2D8dAZWjdzSl1qhmQ"

# –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ - –¥–ª—è OpenAI
# OPENAI_API_KEY="your-openai-api-key"
# OPENAI_MODEL="gpt-4o-mini"

JWT_SECRET="your-super-secret-jwt-key-change-this-in-production"
```

## üîß –®–∞–≥ 2: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

```powershell
npm install
```

## üóÑÔ∏è –®–∞–≥ 3: –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö

### –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å Prisma Client:
```powershell
npm run prisma:generate
```

### –°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –ë–î:
```powershell
npm run prisma:migrate
```

–ü—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∏–º–µ–Ω–∏ –º–∏–≥—Ä–∞—Ü–∏–∏ –≤–≤–µ–¥–∏—Ç–µ: `init`

### –ó–∞–ø–æ–ª–Ω–∏—Ç—å –±–∞–∑—É —Ç–µ—Å—Ç–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏:
```powershell
npm run prisma:seed
```

–≠—Ç–æ –¥–æ–±–∞–≤–∏—Ç:
- 5 –ø—Ä–∏–º–µ—Ä–æ–≤ —Å—Ç—Ä–∞—Ö–æ–≤—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤ (PICC, CPIC, Ping An)
- –¢–µ—Å—Ç–æ–≤–æ–≥–æ –∞–≥–µ–Ω—Ç–∞ (–ª–æ–≥–∏–Ω: admin, –ø–∞—Ä–æ–ª—å: admin123)

## üöÄ –®–∞–≥ 4: –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä

```powershell
npm run start:dev
```

## üåê –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Telegram Webhook (–¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏)

### –û–∫–Ω–æ ‚Ññ1 - –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ç—É–Ω–Ω–µ–ª—å:
```powershell
npx localtunnel --port 3000
```

–°–∫–æ–ø–∏—Ä—É–π—Ç–µ URL —Ç—É–Ω–Ω–µ–ª—è (–Ω–∞–ø—Ä–∏–º–µ—Ä: `https://tangy-colts-change.loca.lt`)

### –û–∫–Ω–æ ‚Ññ2 - –ù–∞—Å—Ç—Ä–æ–π—Ç–µ webhook:
```powershell
$botToken = "8279197548:AAGXNdEXKQUVBoK_qY2D8dAZWjdzSl1qhmQ"
$publicUrl = "https://–≤–∞—à-url.loca.lt"  # –í—Å—Ç–∞–≤—å—Ç–µ URL –∏–∑ –æ–∫–Ω–∞ ‚Ññ1
Invoke-RestMethod -Uri ("https://api.telegram.org/bot{0}/setWebhook?url={1}/channels/telegram/webhook" -f $botToken, $publicUrl) -Method Get
```

### –û–∫–Ω–æ ‚Ññ3 - –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä:
```powershell
cd backend
npm run start:dev
```

## üõ†Ô∏è –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

### –ü—Ä–æ—Å–º–æ—Ç—Ä –ë–î —á–µ—Ä–µ–∑ Prisma Studio:
```powershell
npm run prisma:studio
```

### –ü–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ –ë–î:
```powershell
# –£–¥–∞–ª–∏—Ç–µ —Ñ–∞–π–ª dev.db –∏ –ø–∞–ø–∫—É prisma/migrations
# –ó–∞—Ç–µ–º –∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–Ω–æ–≤–∞:
npm run prisma:migrate
```

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã

1. –û—Ç–∫—Ä–æ–π—Ç–µ Telegram –±–æ—Ç–∞
2. –ù–∞–ø–∏—à–∏—Ç–µ –ª—é–±–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
3. –ë–æ—Ç –¥–æ–ª–∂–µ–Ω –æ—Ç–≤–µ—Ç–∏—Ç—å
4. –°–æ–æ–±—â–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –ë–î (`dev.db`)

## üìö –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
backend/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ modules/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ai/         # AI —Å–µ—Ä–≤–∏—Å (OpenAI)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth/       # –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∞–≥–µ–Ω—Ç–æ–≤
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ channels/   # Telegram webhook
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ chat/       # –ß–∞—Ç —Å–µ—Ä–≤–∏—Å
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ prisma/     # Prisma –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
‚îÇ   ‚îî‚îÄ‚îÄ main.ts
‚îú‚îÄ‚îÄ prisma/
‚îÇ   ‚îî‚îÄ‚îÄ schema.prisma   # –°—Ö–µ–º–∞ –ë–î
‚îú‚îÄ‚îÄ .env               # –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
‚îî‚îÄ‚îÄ dev.db            # SQLite –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
```

## üîç Troubleshooting

### –û—à–∏–±–∫–∞: "Prisma Client not generated"
```powershell
npm run prisma:generate
```

### –û—à–∏–±–∫–∞: "Can't reach database"
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ `.env` —Ñ–∞–π–ª —Å–æ–∑–¥–∞–Ω
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—É—Ç—å –≤ `DATABASE_URL`

### Webhook –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ç—É–Ω–Ω–µ–ª—å –∑–∞–ø—É—â–µ–Ω
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ URL —Ç—É–Ω–Ω–µ–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –≤ webhook
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫


```

```markdown
# üìö Knowledge Base (RAG) - –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ

## –ß—Ç–æ —ç—Ç–æ?

Knowledge Base —Å RAG (Retrieval-Augmented Generation) –ø–æ–∑–≤–æ–ª—è–µ—Ç –±–æ—Ç—É –¥–∞–≤–∞—Ç—å —Ç–æ—á–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –æ —Å—Ç—Ä–∞—Ö–æ–≤—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–∞—Ö.

## –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?

1. **–î–æ–∫—É–º–µ–Ω—Ç—ã —Ä–∞–∑–±–∏–≤–∞—é—Ç—Å—è –Ω–∞ —á–∞–Ω–∫–∏** (—Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã –ø–æ 500 —Å–∏–º–≤–æ–ª–æ–≤)
2. **–ì–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è —ç–º–±–µ–¥–¥–∏–Ω–≥–∏** —á–µ—Ä–µ–∑ OpenAI –¥–ª—è —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–∏—Å–∫–∞
3. **–ü—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è** –∏—â—É—Ç—Å—è –ø–æ—Ö–æ–∂–∏–µ —á–∞–Ω–∫–∏
4. **AI –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç** –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–∞–π–¥–µ–Ω–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏

## API Endpoints

### üìù –î–æ–±–∞–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç

```http
POST /kb/documents
Content-Type: application/json

{
  "companyCode": "PICC",
  "productCode": "TRAVEL_ANNUAL",
  "title": "–ì–æ–¥–æ–≤–æ–π —Ç—É—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–ª–∏—Å",
  "content": "–ü–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞...",
  "fileUrl": "https://example.com/doc.pdf",
  "sourceUrl": "https://picc.com/products/travel",
  "version": "2.0"
}
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "docId": "uuid-here",
  "chunksCount": 5
}
```

### üìã –°–ø–∏—Å–æ–∫ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤

```http
GET /kb/documents?companyCode=PICC&productCode=TRAVEL_ANNUAL
```

**–û—Ç–≤–µ—Ç:**
```json
[
  {
    "id": "uuid",
    "companyCode": "PICC",
    "productCode": "TRAVEL_ANNUAL",
    "title": "–ì–æ–¥–æ–≤–æ–π —Ç—É—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–ª–∏—Å",
    "fileUrl": "...",
    "sourceUrl": "...",
    "version": "2.0",
    "createdAt": "2025-01-01T00:00:00Z",
    "_count": {
      "chunks": 5
    }
  }
]
```

### üîç –ü–æ–∏—Å–∫ –ø–æ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π

```http
POST /kb/search
Content-Type: application/json

{
  "query": "–°–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∞—è —Å—Ç—Ä–∞—Ö–æ–≤–∫–∞?",
  "companyCode": "CPIC",
  "limit": 3
}
```

**–û—Ç–≤–µ—Ç:**
```json
[
  {
    "text": "–ü—Ä–µ–º–∏—É–º –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π –ø–æ–ª–∏—Å CPIC - –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞ –∑–¥–æ—Ä–æ–≤—å—è...",
    "score": 0.87,
    "docTitle": "–ü—Ä–µ–º–∏—É–º –º–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–µ —Å—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏–µ CPIC",
    "companyCode": "CPIC",
    "productCode": "MEDICAL_PREMIUM"
  }
]
```

### üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç

```http
DELETE /kb/documents/:id
```

## –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### PowerShell

#### –î–æ–±–∞–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç:
```powershell
$body = @{
  companyCode = "PICC"
  productCode = "TRAVEL_ANNUAL"
  title = "–ì–æ–¥–æ–≤–æ–π —Ç—É—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–ª–∏—Å"
  content = "–ì–æ–¥–æ–≤–æ–π —Ç—É—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–ª–∏—Å PICC –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç..."
} | ConvertTo-Json

Invoke-RestMethod -Uri "http://localhost:3000/kb/documents" -Method Post -Body $body -ContentType "application/json"
```

#### –ü–æ–∏—Å–∫:
```powershell
$body = @{
  query = "–°–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç —Å—Ç—Ä–∞—Ö–æ–≤–∫–∞ –¥–ª—è —Ç—É—Ä–∏—Å—Ç–æ–≤?"
  limit = 3
} | ConvertTo-Json

Invoke-RestMethod -Uri "http://localhost:3000/kb/search" -Method Post -Body $body -ContentType "application/json"
```

### Curl

#### –î–æ–±–∞–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç:
```bash
curl -X POST http://localhost:3000/kb/documents \
  -H "Content-Type: application/json" \
  -d '{
    "companyCode": "PICC",
    "productCode": "TRAVEL_ANNUAL",
    "title": "–ì–æ–¥–æ–≤–æ–π —Ç—É—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–ª–∏—Å",
    "content": "–ì–æ–¥–æ–≤–æ–π —Ç—É—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–ª–∏—Å PICC –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç..."
  }'
```

#### –ü–æ–∏—Å–∫:
```bash
curl -X POST http://localhost:3000/kb/search \
  -H "Content-Type: application/json" \
  -d '{
    "query": "–°–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç —Å—Ç—Ä–∞—Ö–æ–≤–∫–∞ –¥–ª—è —Ç—É—Ä–∏—Å—Ç–æ–≤?",
    "limit": 3
  }'
```

## –ö–∞–∫ –±–æ—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç RAG

–ö–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–∏—à–µ—Ç –±–æ—Ç—É, —Å–∏—Å—Ç–µ–º–∞:

1. **–ò—â–µ—Ç —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã** –ø–æ –∑–∞–ø—Ä–æ—Å—É
2. **–ü–µ—Ä–µ–¥–∞–µ—Ç –Ω–∞–π–¥–µ–Ω–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ AI**
3. **AI –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç** —Ç–æ–ª—å–∫–æ –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
4. **–ï—Å–ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –Ω–µ—Ç** - –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç —Å–≤—è–∑–∞—Ç—å—Å—è —Å –∞–≥–µ–Ω—Ç–æ–º

### –ü—Ä–∏–º–µ—Ä —Ä–∞–±–æ—Ç—ã:

**–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:** "–°–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç –≥–æ–¥–æ–≤–∞—è —Ç—É—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∞—è —Å—Ç—Ä–∞—Ö–æ–≤–∫–∞?"

**–°–∏—Å—Ç–µ–º–∞:**
1. –ò—â–µ—Ç –≤ KB –¥–æ–∫—É–º–µ–Ω—Ç—ã –ø—Ä–æ —Ç—É—Ä–∏—Å—Ç–∏—á–µ—Å–∫—É—é —Å—Ç—Ä–∞—Ö–æ–≤–∫—É
2. –ù–∞—Ö–æ–¥–∏—Ç "–ì–æ–¥–æ–≤–æ–π —Å—Ç—Ä–∞—Ö–æ–≤–æ–π –ø–æ–ª–∏—Å –¥–ª—è —Ç—É—Ä–∏—Å—Ç–æ–≤ –≤ –ö–∏—Ç–∞–π" (PICC)
3. AI –æ—Ç–≤–µ—á–∞–µ—Ç: "–ì–æ–¥–æ–≤–æ–π —Ç—É—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–ª–∏—Å PICC —Å—Ç–æ–∏—Ç –æ—Ç 2,500 —é–∞–Ω–µ–π –≤ –≥–æ–¥..."

## –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–∑–æ–π –∑–Ω–∞–Ω–∏–π

### –ß–µ—Ä–µ–∑ Prisma Studio:
```powershell
npm run prisma:studio
```

–û—Ç–∫—Ä–æ–µ—Ç—Å—è –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –Ω–∞ http://localhost:5555 –≥–¥–µ –º–æ–∂–Ω–æ:
- –ü—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã
- –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —á–∞–Ω–∫–∏
- –£–¥–∞–ª—è—Ç—å –∑–∞–ø–∏—Å–∏

### –ß–µ—Ä–µ–∑ API:

–°–º. –ø—Ä–∏–º–µ—Ä—ã –≤—ã—à–µ.

## –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ

–ü–æ—Å–ª–µ `npm run prisma:seed` –≤ –ë–î –±—É–¥—É—Ç:

1. **PICC - –¢—É—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–ª–∏—Å** (TRAVEL_ANNUAL)
2. **CPIC - –ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∞—è —Å—Ç—Ä–∞—Ö–æ–≤–∫–∞** (MEDICAL_PREMIUM)
3. **Ping An - –ê–≤—Ç–æ—Å—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏–µ** (AUTO_STANDARD)
4. **PICC - –°—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏–µ –∫–≤–∞—Ä—Ç–∏—Ä—ã** (PROPERTY_HOME)
5. **CPIC - –°—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏–µ –±–∏–∑–Ω–µ—Å–∞** (BUSINESS_SME)

## –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤

–î–ª—è —Ä–∞–±–æ—Ç—ã –≤–µ–∫—Ç–æ—Ä–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞ –Ω—É–∂–µ–Ω **OpenAI API –∫–ª—é—á** –≤ `.env`:

```env
OPENAI_API_KEY="sk-your-api-key"
```

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –º–æ–¥–µ–ª—å: `text-embedding-3-small` (1536 –∏–∑–º–µ—Ä–µ–Ω–∏–π)

### –ë–µ–∑ API –∫–ª—é—á–∞:

–°–∏—Å—Ç–µ–º–∞ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å, –Ω–æ –ø–æ–∏—Å–∫ –±—É–¥–µ—Ç –±–∞–∑–æ–≤—ã–º (–≤—Å–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å score=0).
–î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –º–æ–∂–Ω–æ –æ–±–æ–π—Ç–∏—Å—å –±–µ–∑ –∫–ª—é—á–∞.

## –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤:

–≠–º–±–µ–¥–¥–∏–Ω–≥–∏ —á–∞–Ω–∫–æ–≤ –∫–µ—à–∏—Ä—É—é—Ç—Å—è –≤ –ø–∞–º—è—Ç–∏ –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è –ø–æ–∏—Å–∫–∞.

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è:

–î–ª—è –±–æ–ª—å—à–∏—Ö –±–∞–∑ –∑–Ω–∞–Ω–∏–π (1000+ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤) —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è:
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤–µ–∫—Ç–æ—Ä–Ω—É—é –ë–î (Pinecone, Weaviate, Qdrant)
- –•—Ä–∞–Ω–∏—Ç—å —ç–º–±–µ–¥–¥–∏–Ω–≥–∏ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞

## –£–ª—É—á—à–µ–Ω–∏—è (TODO)

- [ ] –ü–æ–¥–¥–µ—Ä–∂–∫–∞ PDF/DOCX —Ñ–∞–π–ª–æ–≤
- [ ] –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤
- [ ] –í–µ–∫—Ç–æ—Ä–Ω–∞—è –ë–î –≤–º–µ—Å—Ç–æ in-memory –ø–æ–∏—Å–∫–∞
- [ ] –ú—É–ª—å—Ç–∏—è–∑—ã—á–Ω–æ—Å—Ç—å (–∞–Ω–≥–ª–∏–π—Å–∫–∏–π, –∫–∏—Ç–∞–π—Å–∫–∏–π)
- [ ] –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
- [ ] –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

```

–¢–µ–ø–µ—Ä—å —Å–æ–∑–¥–∞–º –∫—Ä–∞—Ç–∫–∏–π README —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º –Ω–æ–≤–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏:

```markdown
# üéâ Knowledge Base + RAG - –ì–æ—Ç–æ–≤–æ!

## –ß—Ç–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ?

### 1. **Knowledge Base –º–æ–¥—É–ª—å** üìö
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–∑–æ–π –∑–Ω–∞–Ω–∏–π –æ —Å—Ç—Ä–∞—Ö–æ–≤—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–∞—Ö
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ä–∞–∑–±–∏–≤–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –Ω–∞ —á–∞–Ω–∫–∏
- API –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/—É–¥–∞–ª–µ–Ω–∏—è/–ø–æ–∏—Å–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤

### 2. **–í–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫** üîç
- –°–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ —á–µ—Ä–µ–∑ OpenAI embeddings
- –ö–æ—Å–∏–Ω—É—Å–Ω–æ–µ —Å—Ö–æ–¥—Å—Ç–≤–æ –¥–ª—è —Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
- –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### 3. **RAG –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è** ü§ñ
- AI –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –∏–∑ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π
- –¢–æ—á–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –æ —Å—Ç—Ä–∞—Ö–æ–≤—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–∞—Ö
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π fallback –µ—Å–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –Ω–µ—Ç

### 4. **–¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ** ‚úÖ
- 5 –≥–æ—Ç–æ–≤—ã—Ö –ø—Ä–∏–º–µ—Ä–æ–≤ —Å—Ç—Ä–∞—Ö–æ–≤—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤
- –ü–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø–æ–∫—Ä—ã—Ç–∏–π –∏ —Ü–µ–Ω
- –¢–µ—Å—Ç–æ–≤—ã–π –∞–≥–µ–Ω—Ç –¥–ª—è –∞–¥–º–∏–Ω–∫–∏

## –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1. –°–æ–∑–¥–∞–π—Ç–µ `.env`:
```env
DATABASE_URL="file:./dev.db"
TELEGRAM_BOT_TOKEN="–≤–∞—à-—Ç–æ–∫–µ–Ω"
OPENAI_API_KEY="–≤–∞—à-–∫–ª—é—á-openai"
JWT_SECRET="—Å–µ–∫—Ä–µ—Ç–Ω—ã–π-–∫–ª—é—á"
```

### 2. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ:
```powershell
cd insurance-chat/backend
npm install
npm run prisma:generate
npm run prisma:migrate
npm run prisma:seed
npm run start:dev
```

### 3. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –±–æ—Ç–∞:
–ù–∞–ø–∏—à–∏—Ç–µ –≤ Telegram –±–æ—Ç—É: **"–°–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç —Ç—É—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∞—è —Å—Ç—Ä–∞—Ö–æ–≤–∫–∞?"**

–ë–æ—Ç –Ω–∞–π–¥–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π –∏ –æ—Ç–≤–µ—Ç–∏—Ç —Ç–æ—á–Ω–æ! üéØ

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
backend/
‚îú‚îÄ‚îÄ src/modules/
‚îÇ   ‚îú‚îÄ‚îÄ kb/                    # ‚≠ê –ù–û–í–´–ô: Knowledge Base
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ kb.service.ts      # –õ–æ–≥–∏–∫–∞ RAG
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ kb.controller.ts   # API endpoints
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ kb.module.ts
‚îÇ   ‚îú‚îÄ‚îÄ ai/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ai.service.ts      # ‚≠ê –û–ë–ù–û–í–õ–ï–ù: RAG –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ chat/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ chat.service.ts    # ‚≠ê –û–ë–ù–û–í–õ–ï–ù: Prisma –ë–î
‚îÇ   ‚îú‚îÄ‚îÄ channels/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ telegram.controller.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ channels.module.ts # ‚≠ê –û–ë–ù–û–í–õ–ï–ù: KB –∏–º–ø–æ—Ä—Ç
‚îÇ   ‚îî‚îÄ‚îÄ prisma/                # ‚≠ê –ù–û–í–´–ô: Prisma –º–æ–¥—É–ª—å
‚îÇ       ‚îú‚îÄ‚îÄ prisma.service.ts
‚îÇ       ‚îî‚îÄ‚îÄ prisma.module.ts
‚îú‚îÄ‚îÄ prisma/
‚îÇ   ‚îú‚îÄ‚îÄ schema.prisma          # ‚≠ê –ò–°–ü–†–ê–í–õ–ï–ù: Relations
‚îÇ   ‚îî‚îÄ‚îÄ seed.ts                # ‚≠ê –ù–û–í–´–ô: –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
‚îú‚îÄ‚îÄ SETUP.md                   # ‚≠ê –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —É—Å—Ç–∞–Ω–æ–≤–∫–µ
‚îú‚îÄ‚îÄ KB_GUIDE.md                # ‚≠ê –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ KB
‚îî‚îÄ‚îÄ README_RAG.md              # ‚≠ê –≠—Ç–æ—Ç —Ñ–∞–π–ª
```

## API Endpoints

### Knowledge Base:

- `POST /kb/documents` - –î–æ–±–∞–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç
- `GET /kb/documents` - –°–ø–∏—Å–æ–∫ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
- `DELETE /kb/documents/:id` - –£–¥–∞–ª–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç
- `POST /kb/search` - –ü–æ–∏—Å–∫ –ø–æ –±–∞–∑–µ

–ü–æ–¥—Ä–æ–±–Ω–µ–µ: [KB_GUIDE.md](./KB_GUIDE.md)

### Chat (—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ):

- `POST /chat/sessions` - –°–æ–∑–¥–∞—Ç—å —Å–µ—Å—Å–∏—é
- `POST /chat/messages` - –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
- `GET /chat/messages/:sessionId` - –ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π

### Telegram Webhook:

- `POST /channels/telegram/webhook` - Webhook –¥–ª—è Telegram

## –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ

–ü–æ—Å–ª–µ seed –¥–æ—Å—Ç—É–ø–Ω—ã:

| –ö–æ–º–ø–∞–Ω–∏—è | –ü—Ä–æ–¥—É–∫—Ç | –û–ø–∏—Å–∞–Ω–∏–µ | –¶–µ–Ω–∞ |
|----------|---------|----------|------|
| PICC | TRAVEL_ANNUAL | –ì–æ–¥–æ–≤–æ–π —Ç—É—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–ª–∏—Å | –æ—Ç 2,500¬•/–≥–æ–¥ |
| CPIC | MEDICAL_PREMIUM | –ü—Ä–µ–º–∏—É–º –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∞—è —Å—Ç—Ä–∞—Ö–æ–≤–∫–∞ | –æ—Ç 8,000¬•/–≥–æ–¥ |
| Ping An | AUTO_STANDARD | –ê–≤—Ç–æ—Å—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏–µ –û–°–ê–ì–û+–ö–ê–°–ö–û | –æ—Ç 950¬•/–≥–æ–¥ |
| PICC | PROPERTY_HOME | –°—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏–µ –∫–≤–∞—Ä—Ç–∏—Ä—ã | –æ—Ç 800¬•/–≥–æ–¥ |
| CPIC | BUSINESS_SME | –°—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏–µ –º–∞–ª–æ–≥–æ –±–∏–∑–Ω–µ—Å–∞ | –æ—Ç 15,000¬•/–≥–æ–¥ |

## –ü—Ä–∏–º–µ—Ä—ã –≤–æ–ø—Ä–æ—Å–æ–≤ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

–°–ø—Ä–æ—Å–∏—Ç–µ –±–æ—Ç–∞ –≤ Telegram:

1. **"–°–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç —Ç—É—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∞—è —Å—Ç—Ä–∞—Ö–æ–≤–∫–∞?"**
   ‚Üí –ù–∞–π–¥–µ—Ç PICC TRAVEL_ANNUAL

2. **"–ß—Ç–æ –ø–æ–∫—Ä—ã–≤–∞–µ—Ç –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∞—è —Å—Ç—Ä–∞—Ö–æ–≤–∫–∞ CPIC?"**
   ‚Üí –ù–∞–π–¥–µ—Ç CPIC MEDICAL_PREMIUM

3. **"–ù—É–∂–Ω–∞ —Å—Ç—Ä–∞—Ö–æ–≤–∫–∞ –Ω–∞ –º–∞—à–∏–Ω—É"**
   ‚Üí –ù–∞–π–¥–µ—Ç Ping An AUTO_STANDARD

4. **"–ö–∞–∫ –∑–∞—Å—Ç—Ä–∞—Ö–æ–≤–∞—Ç—å –∫–≤–∞—Ä—Ç–∏—Ä—É?"**
   ‚Üí –ù–∞–π–¥–µ—Ç PICC PROPERTY_HOME

5. **"–°—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏–µ –¥–ª—è –±–∏–∑–Ω–µ—Å–∞"**
   ‚Üí –ù–∞–π–¥–µ—Ç CPIC BUSINESS_SME

## –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: "–°–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∞—è —Å—Ç—Ä–∞—Ö–æ–≤–∫–∞?"
        ‚Üì
1. Telegram –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ ‚Üí TelegramController
        ‚Üì
2. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ë–î ‚Üí ChatService (Prisma)
        ‚Üì
3. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è embedding –∑–∞–ø—Ä–æ—Å–∞ ‚Üí KbService
        ‚Üì
4. –ò—â—É—Ç—Å—è –ø–æ—Ö–æ–∂–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã (cosine similarity)
        ‚Üì
5. –ù–∞–π–¥–µ–Ω–Ω—ã–µ —á–∞–Ω–∫–∏ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –≤ AI ‚Üí AiService
        ‚Üì
6. AI –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
        ‚Üì
7. –û—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ë–î
```

## –ß—Ç–æ –¥–∞–ª—å—à–µ?

### –°–ª–µ–¥—É—é—â–∏–µ —É–ª—É—á—à–µ–Ω–∏—è:

1. **–í–µ–±-–≤–∏–¥–∂–µ—Ç** - —á–∞—Ç –¥–ª—è —Å–∞–π—Ç–∞
2. **–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å** - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–∞—Ç–∞–º–∏ –∏ KB
3. **Handover** - –ø–µ—Ä–µ–¥–∞—á–∞ –æ—Ç AI –∫ –∞–≥–µ–Ω—Ç—É
4. **Voice** - –≥–æ–ª–æ—Å–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
5. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è polis.online** - –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –ø–æ–ª–∏—Å–æ–≤

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è RAG:

1. –í–µ–∫—Ç–æ—Ä–Ω–∞—è –ë–î (Pinecone/Qdrant)
2. –•—Ä–∞–Ω–µ–Ω–∏–µ —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤ –≤ Prisma
3. –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
4. Batch processing –¥–ª—è –±–æ–ª—å—à–∏—Ö –æ–±—ä–µ–º–æ–≤

## Troubleshooting

### –ë–æ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç "–Ω–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏"
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ seed –≤—ã–ø–æ–ª–Ω–µ–Ω: `npm run prisma:seed`
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ OPENAI_API_KEY –≤ `.env`

### –ü–æ–∏—Å–∫ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ OPENAI_API_KEY –≤–∞–ª–∏–¥–µ–Ω
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –±–∞–ª–∞–Ω—Å OpenAI –∞–∫–∫–∞—É–Ω—Ç–∞
- –ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫

### –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ —Å–æ–∑–¥–∞–µ—Ç—Å—è
- –£–¥–∞–ª–∏—Ç–µ `dev.db` –∏ `prisma/migrations`
- –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–Ω–æ–≤–∞: `npm run prisma:migrate`

## –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- [SETUP.md](./SETUP.md) - –ü–æ–ª–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —É—Å—Ç–∞–Ω–æ–≤–∫–µ
- [KB_GUIDE.md](./KB_GUIDE.md) - –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ Knowledge Base
- [Prisma Docs](https://www.prisma.io/docs) - –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è Prisma
- [OpenAI Embeddings](https://platform.openai.com/docs/guides/embeddings) - OpenAI —ç–º–±–µ–¥–¥–∏–Ω–≥–∏

---

**–°–æ–∑–¥–∞–Ω–æ:** 1 –æ–∫—Ç—è–±—Ä—è 2025
**–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏:** NestJS, Prisma, SQLite, OpenAI, RAG, Telegram Bot API

```

–û—Ç–ª–∏—á–Ω–æ! –î–∞–≤–∞–π—Ç–µ –ø—Ä–æ–≤–µ—Ä–∏–º –∫–æ–¥ –Ω–∞ –æ—à–∏–±–∫–∏:

–ü—Ä–µ–≤–æ—Å—Ö–æ–¥–Ω–æ! –í—Å–µ –≥–æ—Ç–æ–≤–æ –±–µ–∑ –æ—à–∏–±–æ–∫! üéâ

---

## ‚ú® –ß—Ç–æ —è —Å–¥–µ–ª–∞–ª:

### 1. **Knowledge Base –º–æ–¥—É–ª—å** üìö
- ‚úÖ `KbService` - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–∑–æ–π –∑–Ω–∞–Ω–∏–π
- ‚úÖ `KbController` - REST API –¥–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
- ‚úÖ –í–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫ —Å —ç–º–±–µ–¥–¥–∏–Ω–≥–∞–º–∏ OpenAI
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ä–∞–∑–±–∏–≤–∫–∞ —Ç–µ–∫—Å—Ç–∞ –Ω–∞ —á–∞–Ω–∫–∏

### 2. **RAG –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è** ü§ñ
- ‚úÖ `AiService` –æ–±–Ω–æ–≤–ª–µ–Ω - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –±–∞–∑—É –∑–Ω–∞–Ω–∏–π
- ‚úÖ –°–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ –ø–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞–º
- ‚úÖ AI –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ Fallback –µ—Å–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –Ω–µ—Ç

### 3. **–¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ** üóÇÔ∏è
- ‚úÖ 5 —Å—Ç—Ä–∞—Ö–æ–≤—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤ (PICC, CPIC, Ping An)
- ‚úÖ –ü–æ–ª–Ω—ã–µ –æ–ø–∏—Å–∞–Ω–∏—è —Å —Ü–µ–Ω–∞–º–∏ –∏ —É—Å–ª–æ–≤–∏—è–º–∏
- ‚úÖ Seed —Å–∫—Ä–∏–ø—Ç –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –∑–∞–ø—É—Å–∫–∞
- ‚úÖ –¢–µ—Å—Ç–æ–≤—ã–π –∞–≥–µ–Ω—Ç (admin/admin123)

### 4. **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è** üìñ
- ‚úÖ `SETUP.md` - –ø–æ–ª–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏
- ‚úÖ `KB_GUIDE.md` - —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ KB API
- ‚úÖ `README_RAG.md` - –æ–±–∑–æ—Ä –Ω–æ–≤–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏

---

## üöÄ –ß—Ç–æ –¥–µ–ª–∞—Ç—å –¥–∞–ª—å—à–µ:

### **–®–∞–≥ 1:** –°–æ–∑–¥–∞–π—Ç–µ `.env` —Ñ–∞–π–ª

–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `insurance-chat/backend/.env`:

```env
DATABASE_URL="file:./dev.db"
TELEGRAM_BOT_TOKEN="8279197548:AAGXNdEXKQUVBoK_qY2D8dAZWjdzSl1qhmQ"
OPENAI_API_KEY="–≤–∞—à-–∫–ª—é—á-openai"
JWT_SECRET="your-secret-key"
```

> ‚ö†Ô∏è **–í–∞–∂–Ω–æ:** –î–ª—è —Ä–∞–±–æ—Ç—ã RAG –Ω—É–∂–µ–Ω `OPENAI_API_KEY`

### **–®–∞–≥ 2:** –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –ë–î

```powershell
cd insurance-chat\backend
npm install
npm run prisma:generate
npm run prisma:migrate
```

–ü—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∏–º–µ–Ω–∏ –º–∏–≥—Ä–∞—Ü–∏–∏: **`init`**

### **–®–∞–≥ 3:** –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ

```powershell
npm run prisma:seed
```

–≠—Ç–æ –¥–æ–±–∞–≤–∏—Ç 5 —Å—Ç—Ä–∞—Ö–æ–≤—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –≤ –±–∞–∑—É –∑–Ω–∞–Ω–∏–π.

### **–®–∞–≥ 4:** –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä

```powershell
npm run start:dev
```

### **–®–∞–≥ 5:** –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ RAG!

–ù–∞–ø–∏—à–∏—Ç–µ –±–æ—Ç—É –≤ Telegram:
- **"–°–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç —Ç—É—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∞—è —Å—Ç—Ä–∞—Ö–æ–≤–∫–∞?"**
- **"–ß—Ç–æ –ø–æ–∫—Ä—ã–≤–∞–µ—Ç –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∞—è —Å—Ç—Ä–∞—Ö–æ–≤–∫–∞?"**
- **"–ù—É–∂–Ω–∞ —Å—Ç—Ä–∞—Ö–æ–≤–∫–∞ –Ω–∞ –º–∞—à–∏–Ω—É"**

–ë–æ—Ç —Ç–µ–ø–µ—Ä—å –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤! üéØ

---

## üìä –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ RAG

```
Telegram ‚Üí TelegramController
              ‚Üì
         ChatService (—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î)
              ‚Üì
         KbService.search() ‚Üê –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç embedding –∑–∞–ø—Ä–æ—Å–∞
              ‚Üì
         –ù–∞—Ö–æ–¥–∏—Ç –ø–æ—Ö–æ–∂–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã
              ‚Üì
         AiService (RAG) ‚Üê –ø–µ—Ä–µ–¥–∞–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç—ã –≤ GPT
              ‚Üì
         –û—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é + —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î
```

---

## üéØ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ —Ä–∞–∑–≤–∏—Ç–∏—è:

1. **–í–µ–±-–≤–∏–¥–∂–µ—Ç** - —á–∞—Ç –¥–ª—è –≤—Å—Ç—Ä–∞–∏–≤–∞–Ω–∏—è –Ω–∞ —Å–∞–π—Ç
2. **–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å** - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–∞—Ç–∞–º–∏ –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏
3. **Handover** - –ø–µ—Ä–µ–¥–∞—á–∞ –æ—Ç AI –∫ –∂–∏–≤–æ–º—É –∞–≥–µ–Ω—Ç—É
4. **Voice** - –≥–æ–ª–æ—Å–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
5. **polis.online** - –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –ø–æ–ª–∏—Å–æ–≤ —á–µ—Ä–µ–∑ API

**–ß—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–¥–µ–ª–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–º?** üòä

```plaintext
DATABASE_URL="file:./dev.db"
TELEGRAM_BOT_TOKEN="8279197548:AAGXNdEXKQUVBoK_qY2D8dAZWjdzSl1qhmQ"
OPENAI_API_KEY="–≤–∞—à-–∫–ª—é—á-openai"
JWT_SECRET="your-secret-key"
```

```powershell
cd insurance-chat\backend
npm install
npm run prisma:generate
npm run prisma:migrate
```

```powershell
npm run prisma:seed
```

```powershell
npm run start:dev
```

```plaintext
Telegram ‚Üí TelegramController
              ‚Üì
         ChatService (—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î)
              ‚Üì
         KbService.search() ‚Üê –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç embedding –∑–∞–ø—Ä–æ—Å–∞
              ‚Üì
         –ù–∞—Ö–æ–¥–∏—Ç –ø–æ—Ö–æ–∂–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã
              ‚Üì
         AiService (RAG) ‚Üê –ø–µ—Ä–µ–¥–∞–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç—ã –≤ GPT
              ‚Üì
         –û—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é + —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î
```

